<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前后端实现BFF架构（二） | Memory space</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="记忆空间">
    <link rel="preload" href="/assets/css/0.styles.ab177faf.css" as="style"><link rel="preload" href="/assets/js/app.414e898e.js" as="script"><link rel="preload" href="/assets/js/2.2b5dec35.js" as="script"><link rel="preload" href="/assets/js/85.d34d3ccf.js" as="script"><link rel="prefetch" href="/assets/js/10.cea5db77.js"><link rel="prefetch" href="/assets/js/100.e8f4d692.js"><link rel="prefetch" href="/assets/js/101.591a1bf0.js"><link rel="prefetch" href="/assets/js/102.f3e8101f.js"><link rel="prefetch" href="/assets/js/103.b15b9dc3.js"><link rel="prefetch" href="/assets/js/104.b4e03942.js"><link rel="prefetch" href="/assets/js/105.c942f624.js"><link rel="prefetch" href="/assets/js/106.1f1659e4.js"><link rel="prefetch" href="/assets/js/107.7175b6cf.js"><link rel="prefetch" href="/assets/js/108.3c4927cc.js"><link rel="prefetch" href="/assets/js/109.4ad3b4a5.js"><link rel="prefetch" href="/assets/js/11.cce96b68.js"><link rel="prefetch" href="/assets/js/110.b723c443.js"><link rel="prefetch" href="/assets/js/111.85e41162.js"><link rel="prefetch" href="/assets/js/12.612c7716.js"><link rel="prefetch" href="/assets/js/13.bf9804de.js"><link rel="prefetch" href="/assets/js/14.7f3c0563.js"><link rel="prefetch" href="/assets/js/15.53a9f16c.js"><link rel="prefetch" href="/assets/js/16.a00a2ffd.js"><link rel="prefetch" href="/assets/js/17.75c8bc55.js"><link rel="prefetch" href="/assets/js/18.7be85063.js"><link rel="prefetch" href="/assets/js/19.9795353c.js"><link rel="prefetch" href="/assets/js/20.acaa079e.js"><link rel="prefetch" href="/assets/js/21.66368eab.js"><link rel="prefetch" href="/assets/js/22.8e691c9e.js"><link rel="prefetch" href="/assets/js/23.ef6288d2.js"><link rel="prefetch" href="/assets/js/24.1b1bfe0d.js"><link rel="prefetch" href="/assets/js/25.3c32a8ec.js"><link rel="prefetch" href="/assets/js/26.e8183b8f.js"><link rel="prefetch" href="/assets/js/27.06f00591.js"><link rel="prefetch" href="/assets/js/28.113ea795.js"><link rel="prefetch" href="/assets/js/29.332c2ea3.js"><link rel="prefetch" href="/assets/js/3.2d22cccd.js"><link rel="prefetch" href="/assets/js/30.c0e24ce3.js"><link rel="prefetch" href="/assets/js/31.d343c693.js"><link rel="prefetch" href="/assets/js/32.35bfc8eb.js"><link rel="prefetch" href="/assets/js/33.c7878a02.js"><link rel="prefetch" href="/assets/js/34.264850c5.js"><link rel="prefetch" href="/assets/js/35.1544c6da.js"><link rel="prefetch" href="/assets/js/36.1ed171c5.js"><link rel="prefetch" href="/assets/js/37.d715c829.js"><link rel="prefetch" href="/assets/js/38.6807fe0d.js"><link rel="prefetch" href="/assets/js/39.090178f2.js"><link rel="prefetch" href="/assets/js/4.bd0ac780.js"><link rel="prefetch" href="/assets/js/40.07c06c4b.js"><link rel="prefetch" href="/assets/js/41.66eb3a2e.js"><link rel="prefetch" href="/assets/js/42.96914832.js"><link rel="prefetch" href="/assets/js/43.e252f7dd.js"><link rel="prefetch" href="/assets/js/44.f2350798.js"><link rel="prefetch" href="/assets/js/45.af043aaf.js"><link rel="prefetch" href="/assets/js/46.e7590fb9.js"><link rel="prefetch" href="/assets/js/47.4baf33f1.js"><link rel="prefetch" href="/assets/js/48.78e9872d.js"><link rel="prefetch" href="/assets/js/49.108aba5c.js"><link rel="prefetch" href="/assets/js/5.b6df23a7.js"><link rel="prefetch" href="/assets/js/50.b39f62fc.js"><link rel="prefetch" href="/assets/js/51.c20680ba.js"><link rel="prefetch" href="/assets/js/52.4e7df985.js"><link rel="prefetch" href="/assets/js/53.c1d11e72.js"><link rel="prefetch" href="/assets/js/54.b2abb2d3.js"><link rel="prefetch" href="/assets/js/55.ab694255.js"><link rel="prefetch" href="/assets/js/56.551b8404.js"><link rel="prefetch" href="/assets/js/57.ebcce9cb.js"><link rel="prefetch" href="/assets/js/58.b9ac1e6e.js"><link rel="prefetch" href="/assets/js/59.aa33affa.js"><link rel="prefetch" href="/assets/js/6.b81681ba.js"><link rel="prefetch" href="/assets/js/60.84b621ed.js"><link rel="prefetch" href="/assets/js/61.dac79e08.js"><link rel="prefetch" href="/assets/js/62.a7b190c4.js"><link rel="prefetch" href="/assets/js/63.69909b9b.js"><link rel="prefetch" href="/assets/js/64.d6e03a62.js"><link rel="prefetch" href="/assets/js/65.684a2814.js"><link rel="prefetch" href="/assets/js/66.44c4cd5e.js"><link rel="prefetch" href="/assets/js/67.686903ae.js"><link rel="prefetch" href="/assets/js/68.ba59f8c5.js"><link rel="prefetch" href="/assets/js/69.f9c5422f.js"><link rel="prefetch" href="/assets/js/7.bd992b3d.js"><link rel="prefetch" href="/assets/js/70.4a5a5e5b.js"><link rel="prefetch" href="/assets/js/71.b9ee7b87.js"><link rel="prefetch" href="/assets/js/72.dc106525.js"><link rel="prefetch" href="/assets/js/73.481683ea.js"><link rel="prefetch" href="/assets/js/74.3dc3b39a.js"><link rel="prefetch" href="/assets/js/75.337c8c6d.js"><link rel="prefetch" href="/assets/js/76.88cb64ac.js"><link rel="prefetch" href="/assets/js/77.5c705847.js"><link rel="prefetch" href="/assets/js/78.b1988d9d.js"><link rel="prefetch" href="/assets/js/79.05712423.js"><link rel="prefetch" href="/assets/js/8.60f4381c.js"><link rel="prefetch" href="/assets/js/80.cb16545c.js"><link rel="prefetch" href="/assets/js/81.452509cd.js"><link rel="prefetch" href="/assets/js/82.5da948ad.js"><link rel="prefetch" href="/assets/js/83.6bc21179.js"><link rel="prefetch" href="/assets/js/84.85317d6f.js"><link rel="prefetch" href="/assets/js/86.95012de3.js"><link rel="prefetch" href="/assets/js/87.c9ff9779.js"><link rel="prefetch" href="/assets/js/88.1615b8fc.js"><link rel="prefetch" href="/assets/js/89.ffec0272.js"><link rel="prefetch" href="/assets/js/9.d57dabe4.js"><link rel="prefetch" href="/assets/js/90.20781978.js"><link rel="prefetch" href="/assets/js/91.030a0b2a.js"><link rel="prefetch" href="/assets/js/92.7c05375d.js"><link rel="prefetch" href="/assets/js/93.8bd58035.js"><link rel="prefetch" href="/assets/js/94.2a0b660f.js"><link rel="prefetch" href="/assets/js/95.8837c612.js"><link rel="prefetch" href="/assets/js/96.9196c31f.js"><link rel="prefetch" href="/assets/js/97.b03bbd6f.js"><link rel="prefetch" href="/assets/js/98.0da533a2.js"><link rel="prefetch" href="/assets/js/99.6194f1ed.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ab177faf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Memory space</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/L-SUI/note/tree/master/every" target="_blank" rel="noopener noreferrer" class="nav-link external">
  每日
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/L-SUI/note/tree/master/LeetCode/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="友邻" class="dropdown-title"><span class="title">友邻</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://notes.itzkp.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  朱昆鹏
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/L-SUI/note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/L-SUI/note/tree/master/every" target="_blank" rel="noopener noreferrer" class="nav-link external">
  每日
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/L-SUI/note/tree/master/LeetCode/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="友邻" class="dropdown-title"><span class="title">友邻</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://notes.itzkp.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  朱昆鹏
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/L-SUI/note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>源码解析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>你不知道的css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构与算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Server</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/server/bff1.html" class="sidebar-link">前后端实现BFF架构（一）</a></li><li><a href="/note/server/bff2.html" aria-current="page" class="active sidebar-link">前后端实现BFF架构（二）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/server/bff2.html#零、写在前面" class="sidebar-link">零、写在前面</a></li><li class="sidebar-sub-header"><a href="/note/server/bff2.html#一、添加错误日志记录" class="sidebar-link">一、添加错误日志记录</a></li><li class="sidebar-sub-header"><a href="/note/server/bff2.html#二、es6模块化改造" class="sidebar-link">二、ES6模块化改造</a></li><li class="sidebar-sub-header"><a href="/note/server/bff2.html#三、添加model层调用后端接口" class="sidebar-link">三、添加Model层调用后端接口</a></li><li class="sidebar-sub-header"><a href="/note/server/bff2.html#四、bff请求后端数据渲染到页面" class="sidebar-link">四、BFF请求后端数据渲染到页面</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/server/bff2.html#对axios进行简单的容错处理" class="sidebar-link">对Axios进行简单的容错处理</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/server/bff2.html#五、如何编写一个自己的函数式编程库" class="sidebar-link">五、如何编写一个自己的函数式编程库</a></li><li class="sidebar-sub-header"><a href="/note/server/bff2.html#六、前端测试" class="sidebar-link">六、前端测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/server/bff2.html#i、e2e测试" class="sidebar-link">I、e2e测试</a></li><li class="sidebar-sub-header"><a href="/note/server/bff2.html#ii、前端接口测试" class="sidebar-link">II、前端接口测试</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/server/bff2.html#七、总结" class="sidebar-link">七、总结</a></li></ul></li><li><a href="/note/server/ioc_bigpipe.html" class="sidebar-link">前端架构师启蒙课第一讲-走进IOC</a></li><li><a href="/note/server/mvc.html" class="sidebar-link">前端架构分离之后端开发</a></li><li><a href="/note/server/mysql.html" class="sidebar-link">Mysql 初探</a></li><li><a href="/note/server/node.html" class="sidebar-link">NodeJS 初探</a></li><li><a href="/note/server/node_optimization.html" class="sidebar-link">NodeJS 性能调优</a></li><li><a href="/note/server/pm2.html" class="sidebar-link">PM2</a></li><li><a href="/note/server/vue_ssr.html" class="sidebar-link">深度实现Vue SSR原理</a></li><li><a href="/note/server/webpack_bff.html" class="sidebar-link">Webpack从0-1深度细化BFF（一）</a></li><li><a href="/note/server/webpack_bff2.html" class="sidebar-link">Webpack从0-1深度细化BFF（二）</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>OS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>常用工具</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>自动化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>js相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>QA相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>文章收藏</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="前后端实现bff架构（二）"><a href="#前后端实现bff架构（二）" class="header-anchor">#</a> 前后端实现BFF架构（二）</h1> <h2 id="零、写在前面"><a href="#零、写在前面" class="header-anchor">#</a> 零、写在前面</h2> <p>在**前后端实现BFF架构（一）**里面我们使用Koa2及一系列的插件简单的搭出了Node服务的MVC框架，这篇文章是上一篇文章的后续，来完成接下来的一些工作。这篇文章我们将从以下几个点来完善我们的BFF架构：</p> <ul><li><p>对KOA2项目做一些容错</p></li> <li><p>将YII的后端项目写成只提供接口的形式，给NodeJS使用</p></li> <li><p>PlayWright完成页面测试</p> <p>mocha完成Node接口测试</p></li> <li><p>业务逻辑用ES6编写，并将浏览器支持分开，不支持的用babel编译system.js加载</p></li> <li><p>每一次新增记录的点击用函数式编程的方式稀释（节流）。</p></li></ul> <h2 id="一、添加错误日志记录"><a href="#一、添加错误日志记录" class="header-anchor">#</a> 一、添加错误日志记录</h2> <p>添加错误日志记录需要使用一个库<code>log4js</code>。我们先安装这个插件，因为我们的日志记录要在线上使用，所以就不需要只安装在开发环境中了：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">npm</span> <span class="token function">install</span> log4js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>安装完之后我们在app.js中引入<code>log4js</code>，</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* app.js */</span>

<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-swig'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server_static <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> historyApiFallback <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa2-connect-history-api-fallback'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> log4js <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;log4js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 引入log4js</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> initController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./controllers/index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> errorHandle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./middleware/ErrorHandle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// log4js的初始化和设置</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置日志级别为debug级别，也可以设置为其他的级别。</span>
logger<span class="token punctuation">.</span>level <span class="token operator">=</span> <span class="token string">&quot;debug&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 这条日志会在控制台输出</span>
logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Some debug messages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">server_static</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>staticDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">historyApiFallback</span><span class="token punctuation">(</span><span class="token punctuation">{</span> index<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> whiteList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/api'</span><span class="token punctuation">,</span> <span class="token string">'/activity'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>render <span class="token operator">=</span> co<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 模板文件的路径和是否缓存尽量的放在配置文件中，可以随意配置。</span>
  root<span class="token operator">:</span> config<span class="token punctuation">.</span>viewsDir<span class="token punctuation">,</span>
  cache<span class="token operator">:</span> config<span class="token punctuation">.</span>cache
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

errorHandle<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">initController</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">server is running at http://loaclhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>根据上面的代码注释，我们可以看到控制台中输出了<code>Some debug message</code>字样的日志。log4js比自带的日志打印优越的地方还在于，它带有时间戳，可以更加细致的去定位问题。除了日志的时间，log4js还会区分日志的级别和日志的分类。</p> <img src="/server/log4.png" alt="node-app.png" style="zoom:50%;"> <p>我们可以看一下log4js都支持什么日志级别：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* log4js日志级别 */</span>

<span class="token keyword">const</span> logger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">&quot;cheese&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Entering cheese testing&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Got cheese.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Cheese is Comté.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Cheese is quite smelly.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Cheese is too ripe!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">&quot;Cheese was breeding ground for listeria.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>我们可以看到log4js支持的日志级别一共是六种级别，分别是<code>trace</code>、<code>debug</code>、<code>info</code>、<code>warn</code>、<code>error</code>、<code>fatel</code>。我们在生产中遇到问题排查的时候一般都是去查看问题的日志，但是日志如果只在控制台中输出，这样的话不利于管理，那么为了解决这个问题，我们需要对日志就行本地的持久化，也就是把日志写入到日志文件中去。下面我们来实现一下日志的本地化。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* app.js */</span>

<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-swig'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server_static <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> historyApiFallback <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa2-connect-history-api-fallback'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> log4js <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;log4js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 引入log4js</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> initController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./controllers/index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> errorHandle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./middleware/ErrorHandle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// log4js的初始化和设置</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置日志级别为debug级别，也可以设置为其他的级别。</span>
logger<span class="token punctuation">.</span>level <span class="token operator">=</span> <span class="token string">&quot;debug&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 这条日志会在控制台输出</span>
logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Some debug messages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 配置log输出文件</span>
log4js<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  appenders<span class="token operator">:</span> <span class="token punctuation">{</span> globalError<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span> filename<span class="token operator">:</span> <span class="token string">&quot;./logs/error.log&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  categories<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span> appenders<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;globalError&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> level<span class="token operator">:</span> <span class="token string">&quot;error&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">server_static</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>staticDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">historyApiFallback</span><span class="token punctuation">(</span><span class="token punctuation">{</span> index<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> whiteList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/api'</span><span class="token punctuation">,</span> <span class="token string">'/activity'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>render <span class="token operator">=</span> co<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 模板文件的路径和是否缓存尽量的放在配置文件中，可以随意配置。</span>
  root<span class="token operator">:</span> config<span class="token punctuation">.</span>viewsDir<span class="token punctuation">,</span>
  cache<span class="token operator">:</span> config<span class="token punctuation">.</span>cache
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

errorHandle<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">initController</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">server is running at http://loaclhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>通过我们的设置我们可以清楚的看到，记录的错误的名称是<code>globalError</code>，<code>type: &quot;file&quot;</code>就是以文件的形式存储在filename所指定的<code>./logs/error.log</code>文件中。categories中的appenders是错误类型 ”globalError“对应了 appenders中的globalError。<strong>level: &quot;error&quot;</strong>，这个设置的是error级别或者大于error级别的的错误日志才会记录到文件中。</p> <p>那么，现在配置好之后我们来测试一下，首先我们在app.js中手动输出全部等级的log：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* app.js */</span>

<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-swig'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server_static <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> historyApiFallback <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa2-connect-history-api-fallback'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> log4js <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;log4js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 引入log4js</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> initController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./controllers/index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> errorHandle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./middleware/ErrorHandle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 配置log输出文件</span>
log4js<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  appenders<span class="token operator">:</span> <span class="token punctuation">{</span> globalError<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span> filename<span class="token operator">:</span> <span class="token string">&quot;./logs/error.log&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  categories<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span> appenders<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;globalError&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> level<span class="token operator">:</span> <span class="token string">&quot;error&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// log4js的初始化和设置，日志类型配置成globalError，这里要与前面的日志文件的错误名称配置相同。</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">'globalError'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 我们手动输出所有的日志类型</span>
logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Entering cheese testing&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Got cheese.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Cheese is Comté.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Cheese is quite smelly.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Cheese is too ripe!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">&quot;Cheese was breeding ground for listeria.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">server_static</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>staticDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">historyApiFallback</span><span class="token punctuation">(</span><span class="token punctuation">{</span> index<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> whiteList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/api'</span><span class="token punctuation">,</span> <span class="token string">'/activity'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>render <span class="token operator">=</span> co<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 模板文件的路径和是否缓存尽量的放在配置文件中，可以随意配置。</span>
  root<span class="token operator">:</span> config<span class="token punctuation">.</span>viewsDir<span class="token punctuation">,</span>
  cache<span class="token operator">:</span> config<span class="token punctuation">.</span>cache
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

errorHandle<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">initController</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">server is running at http://loaclhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>保存代码，自动执行之后，我们在看一下我们的项目目录：</p> <img src="/server/log-err.png" alt="node-app.png" style="zoom:50%;"> <p>我们可以看到项目中多了一个log目录，里面有一个error.log日志文件，里面记录的日志和我们手动输出的日志是相同的，日记的级别也和我们的设置相同，说明日志的本地化功能是生效的。</p> <p>那么我们现在就要在容错的功能中加入错误日志的记录，这个功能毫无疑问要添加在errorHandle的中间件中（/middleware/errorHandle），日志的记录需要log4js的getterLogger，所以我们要把logger实例传到errorHandle的error方法中：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* app.js */</span>

<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-swig'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server_static <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> historyApiFallback <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa2-connect-history-api-fallback'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> log4js <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;log4js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> initController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./controllers/index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> errorHandle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./middleware/ErrorHandle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 配置log输出文件</span>
log4js<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  appenders<span class="token operator">:</span> <span class="token punctuation">{</span> globalError<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span> filename<span class="token operator">:</span> <span class="token string">&quot;./logs/error.log&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  categories<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span> appenders<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;globalError&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> level<span class="token operator">:</span> <span class="token string">&quot;error&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// log4js的初始化和设置，日志类型配置成globalError，这里要与前面的日志文件的错误名称配置相同。</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">'globalError'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">server_static</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>staticDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">historyApiFallback</span><span class="token punctuation">(</span><span class="token punctuation">{</span> index<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> whiteList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/api'</span><span class="token punctuation">,</span> <span class="token string">'/activity'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>render <span class="token operator">=</span> co<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 模板文件的路径和是否缓存尽量的放在配置文件中，可以随意配置。</span>
  root<span class="token operator">:</span> config<span class="token punctuation">.</span>viewsDir<span class="token punctuation">,</span>
  cache<span class="token operator">:</span> config<span class="token punctuation">.</span>cache
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 传入logger实例</span>
errorHandle<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">initController</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">server is running at http://loaclhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* middleware/errorHandle.js */</span>

<span class="token keyword">class</span> <span class="token class-name">ErrorHandle</span> <span class="token punctuation">{</span>
  <span class="token comment">// app传入的logger实例</span>
  <span class="token keyword">static</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> logger</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'友好的404页面'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// catch把错误对象传入</span>
        <span class="token comment">// 发生错误的时候，记录日志</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'500请求，正在积极修复。'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> ErrorHandle<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* conteollers/indexController.js */</span>

<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Controller'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">IndexController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">actionIndex</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'测试log4js日志本地化'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home/index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> IndexController<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>以上的代码就是log4js的所有测试代码，我们来简单的分析一下。首先我们在app.js中初始化logger实例，然后把logger实例传入错误捕获中间件的<code>errorHandle.error</code>中，再看错误捕获中间件的处理，需要拿到logger实例，然后再出错的分支下，记录错误日志。这是后的try……catch必须要传入err对象。以便记录错误的详细信息。最后我们在indexController中手动抛出一个错误。我们来请求一下首页，首页毫无疑问会出现<code>500请求，正在积极修复。</code>，看看最终的错误日志：</p> <img src="/server/log4js-test.png" alt="node-app.png" style="zoom:50%;"> <p>到此为止，我们使用log4js实现错误日志的本地化存储功能全部实现。最后我们还要解决一个问题，如果日志文件过大怎么解决？</p> <p><strong>解决日志文件过大的问题：</strong></p> <ul><li>设置一个最大日志数以及清理日志的时间间隔，</li> <li>以清理日志时间间隔开启一个定时任务</li> <li>获取所有日志，按日志生成时间（日志名）做一个倒序，按照排列顺序保留前最大数值的文件。其余删除。</li></ul> <h2 id="二、es6模块化改造"><a href="#二、es6模块化改造" class="header-anchor">#</a> 二、ES6模块化改造</h2> <p>我们项目的编写现在都是使用的CommonJS，在Node中也可以使用ES6的模块化进行开发，所以我们可以使用把现在项目中的CommonJS改写成ESModule形式。</p> <p>在代码的书写形式上做如下修改：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 修改之前</span>
<span class="token keyword">const</span> xxx <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 修改之后</span>
<span class="token keyword">import</span> xxx <span class="token keyword">from</span> <span class="token string">'xxx'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>但是如果我们只是在引入的时候做这种改写，代码必定会挂掉，原因很简单我们只是在引入的时候使用了ESModule的形式，但是在导出的时候还是使用的CommonJS，这必定会出问题。我们自己编写的模块要改成ESModule的导出形式，但是问题时Koa等相当一部分Node库是使用CommonJS编写的，并不支持ESModule。</p> <p>为了解决上述的问题我们可以使用<code>@babel/node</code> 插件解决，安装@babel/node：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ npm install @babel/node -D
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>除了@babel/node我们还需要安装一个babel套件,，在开发环境进行代码的转化：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>$ npm install @babel<span class="token operator">/</span>preset<span class="token operator">-</span>env <span class="token operator">-</span><span class="token constant">D</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>安装完这些之后我们还需要一些简单的配置：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// .babelrc</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>配置完之后我们需要对更改package.json中的启动命令，让babel转化一下app.js：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;BFF-Project&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MIT&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;NODE_ENV=development nodemon --exec 'babel-node ./app.js'&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@koa/router&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^10.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;co&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.6.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.13.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa-static&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa-swig&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.2.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa2-connect-history-api-fallback&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.1.3&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;log4js&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.3.0&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@babel/core&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^7.14.5&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;@babel/node&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^7.14.5&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;@babel/preset-env&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^7.14.5&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>最后我们把自己编写的代码，导出方式全部改写成ESModule的形式。</p> <h2 id="三、添加model层调用后端接口"><a href="#三、添加model层调用后端接口" class="header-anchor">#</a> 三、添加Model层调用后端接口</h2> <p>BFF层需要通过HTTP请求PHP后端的数据：</p> <ul><li>首先我们先改写PHP的后端代码，把PHP的代码改成接口：</li></ul> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">/* basic/controllers/BooksController.js */</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">actionIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$searchModel</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BooksSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$dataProvider</span> <span class="token operator">=</span> <span class="token variable">$searchModel</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">search</span><span class="token punctuation">(</span>Yii<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$app</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">queryParams</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// return $this-&gt;render('index', [</span>
    <span class="token comment">//     'searchModel' =&gt; $searchModel,</span>
    <span class="token comment">//     'dataProvider' =&gt; $dataProvider,</span>
    <span class="token comment">// ]);</span>
  	<span class="token comment">// 可以看到这里我们把actioninIndex的数据注入，改写成了返回JSON数据，接口改造完成</span>
    Yii<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$app</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">response</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">format</span> <span class="token operator">=</span> Response<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">FORMAT_JSON</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$dataProvider</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">getModels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>我们把YII单体应用的controller里面的方法改写成了接口，用以返回JSON数据。</p> <ul><li>然后我们在Node项目下的models目录下创建一个BooksModel，代码如下：</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* /models/BooksModel.js */</span>

<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">BooksModel</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取图书列表</span>
  <span class="token function">getBookList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里请求的是PHP后端服务器的接口</span>
    <span class="token keyword">return</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost/basic/web/index.php?r=books/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 查找图书</span>
  <span class="token function">findBooB</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> BooksModel<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>我们在Node中使用axios请求PHP后端的接口。然后作为getBookList方法的返回值，在这里由于我们的Node也是MVC模式，所以我们要创建一个BooksModel类来管理所有关于图书的增删改查的操作，每个操作我们使用一个方法来实现。getBookList就是获取如数列表的方法。</p> <ul><li>现在我们准备好了Model，就需要controller管理路由，然后返回接口数据了。</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* controllers/ApiController.js */</span>

<span class="token keyword">import</span> Controller <span class="token keyword">from</span> <span class="token string">'./Controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> BooksModel <span class="token keyword">from</span> <span class="token string">'../models/BooksModel'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ApiController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">async</span> <span class="token function">actionBooksList</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> booksModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BooksModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> booksModel<span class="token punctuation">.</span><span class="token function">getBookList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ApiController<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>之前的ApiController是返回的一个写死的JSON，现在我们改写它使控制器对象上的实例方法返回动态数据，首先引入BooksModel，然后actionBooksList方法中实例化BooksModel对象，调用实例方法，取得从PHP后台请求到Node的数据，要注意的是当前的请求时HTTP请求是异步操作。所以使用了async await。最后把JSON数据返回。</p> <p>下面我们来添加一下Node的getBookList路由：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* controllers/index.js */</span>

<span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">&quot;@koa/router&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> IndexController <span class="token keyword">from</span> <span class="token string">'./IndexController'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> indexController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ApiController  <span class="token keyword">from</span> <span class="token string">'./ApiController'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> apiController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApiController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ActivityController <span class="token keyword">from</span> <span class="token string">'./ActivityController'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> actionActivity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> VueController <span class="token keyword">from</span> <span class="token string">'./VueController'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vueController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> BooksController <span class="token keyword">from</span> <span class="token string">'./BooksController'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> booksController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BooksController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">initController</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> indexController<span class="token punctuation">.</span>actionIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 这里添加了bookslist接口路由</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/bookslist'</span><span class="token punctuation">,</span> apiController<span class="token punctuation">.</span>actionBooksList<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/vue'</span><span class="token punctuation">,</span> vueController<span class="token punctuation">.</span>actionVue<span class="token punctuation">)</span><span class="token punctuation">;</span>

  app
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> initController<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><ul><li>最后我们在浏览器地址栏输入 <code>http://localhost:8000/api/booklist</code>：</li></ul> <img src="/server/bookslist.png" alt="node-app.png" style="zoom:50%;"> <p>到现在为止我们的BFF层调用后端的接口这一功能就全部实现了。</p> <h2 id="四、bff请求后端数据渲染到页面"><a href="#四、bff请求后端数据渲染到页面" class="header-anchor">#</a> 四、BFF请求后端数据渲染到页面</h2> <p>我们在Node中请求后端的接口，获得数据之后希望渲染到页面上，这个功能的实现需要以下几步：</p> <ul><li><p>编写BooksController控制器：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* controllers/BookController */</span>

<span class="token keyword">import</span> Controller <span class="token keyword">from</span> <span class="token string">'./Controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> BooksModel <span class="token keyword">from</span> <span class="token string">'../models/BooksModel'</span>

<span class="token keyword">class</span> <span class="token class-name">BooksController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">actionBooksListPage</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> booksModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BooksModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> booksModel<span class="token punctuation">.</span><span class="token function">getBookList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'books/list'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> data<span class="token operator">:</span> result<span class="token punctuation">.</span>data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> BooksController<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>引入BooksModel之后，在actionBooksListPage方法中调用getBookList方法获取数据，最后把数据注入到view模板中。</p></li> <li><p>编写books/list模板</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- views/books/list.html --&gt;</span>
<span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>图书列表页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>图书列表页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  {% for item in data %}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>{{ item.name }} - {{ item.price }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  {% endfor %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>循环渲染bookslist数据。</p></li></ul> <p>到这里我们就明确的讲完了怎么把Node请求回来的JSON数据渲染到模板中。</p> <p>到现在为止，我们整体上BFF的流程就完全的讲解完毕了，代码也进行了完全的实现。实现完成之后我们还有很多工作要做：</p> <ol><li>对于axios我们需要进行封装，一般不能直接使用，因为我们不能完全信任从后端请求过来的数据。需要在axios这一步骤中进行容错的处理。</li> <li>还要对前端的页面进行自动化的测试。</li></ol> <h3 id="对axios进行简单的容错处理"><a href="#对axios进行简单的容错处理" class="header-anchor">#</a> 对Axios进行简单的容错处理</h3> <p>我们在请求后端的数据时，有可能后端没有给我们正确的数据，这时候很可能导致我们的页面崩溃。所以我们有必要封装一下axios，对请求做一些容错。</p> <p>在utils目录中新建一个safeRequest.js：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* utils/safeRequest.js */</span>

<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">SafeRequest</span> <span class="token punctuation">{</span>
  <span class="token comment">// 统一设置返回的响应状态码和状态信息，这里的响应状态码一般都是公司内部指定的一套标准。</span>

  <span class="token keyword">static</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">{</span>
      code<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">axios</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">'OK'</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>data <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里可以做统一的错误日志捕获</span>
        result<span class="token punctuation">.</span>message <span class="token operator">=</span> err<span class="token punctuation">.</span>message<span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> SafeRequest<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>我们看到，在封装之后的axios中，我们可以定义一些公司内部使用的响应状态规范，然后根据不同的状态组装result对象，最后返回。而且在出错的时候还可以统一的做错误日志的捕获。</p> <p>这样封装的好处在于我们对于请求能够集中的管理，不至于写重复的代码。其实axios的功能十分强大，还可以做请求的拦截和响应的拦截，让我们在请求发出之前和收到响应之前做一些业务需要的事情。在真正的业务场景中，可以根据业务的独特性，不断的丰富和健壮这一部分代码。</p> <h2 id="五、如何编写一个自己的函数式编程库"><a href="#五、如何编写一个自己的函数式编程库" class="header-anchor">#</a> 五、如何编写一个自己的函数式编程库</h2> <p>我们如果想编写一个自己的函数式编程库，那么就需要阅读一下经典的函数式编程库的源码：</p> <ul><li>Underscore</li> <li>Lodash</li></ul> <p>以上这两个都是非常优秀的函数式编程库，笔者建议大家先熟练使用Lodash，然后再尝试读一下Lodash的源码。下面我们就尝试阅读源码，源码的阅读我在github上已经分析过了，接下来我们直接写一个自己的函数式编程库：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* utils/myUtils */</span>

<span class="token comment">/* 编写自己的库 */</span>

<span class="token comment">// 写一个闭包  函数级作用域去隔离</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断执行环境</span>
    <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token keyword">typeof</span> self <span class="token operator">==</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> self<span class="token punctuation">.</span>self <span class="token operator">===</span> self <span class="token operator">&amp;&amp;</span> self <span class="token operator">||</span>
        <span class="token keyword">typeof</span> global <span class="token operator">==</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> global<span class="token punctuation">.</span>global <span class="token operator">===</span> global <span class="token operator">&amp;&amp;</span> global <span class="token operator">||</span>
        <span class="token keyword">this</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 核心</span>
    <span class="token comment">// 构造安全的构造函数</span>
    <span class="token keyword">var</span> <span class="token function-variable function">_</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">_</span><span class="token punctuation">)</span> <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'new之前'</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">_</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果前边两个条件都不满足</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_wrapped <span class="token operator">=</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

     <span class="token comment">// 功能非常丰富</span>
     _<span class="token punctuation">.</span><span class="token function-variable function">map</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    _<span class="token punctuation">.</span><span class="token function-variable function">each</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fn</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> arr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    _<span class="token punctuation">.</span><span class="token function-variable function">functions</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> names<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> names<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    _<span class="token punctuation">.</span><span class="token function-variable function">isFunction</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">typeof</span> obj <span class="token operator">==</span> <span class="token string">'function'</span> <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">/* 
      节流函数
      一般打三个点
      1. 在一定的时间内，函数只执行一次
      2. 第一次触发，会立即执行
      3. 如果再间隔时间内触发，会在间隔时间末尾再执行一次
    */</span>
   _<span class="token punctuation">.</span><span class="token function-variable function">throttle</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb<span class="token punctuation">,</span>t</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> isFirst <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> execDate <span class="token operator">=</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> timeoutId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>isFirst<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// 立即执行</span>
                <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                execDate <span class="token operator">=</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                isFirst <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token comment">// 如果不是第一次</span>
                <span class="token keyword">const</span> currentDate <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>currentDate <span class="token operator">-</span> execDate <span class="token operator">&gt;=</span>t<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    execDate <span class="token operator">=</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    timeoutId <span class="token operator">&amp;&amp;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeoutId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 要间隔的时间 - 已经过了多长时间(currentDate-execDate)</span>
                    <span class="token keyword">const</span> timeWait <span class="token operator">=</span> t <span class="token operator">-</span> <span class="token punctuation">(</span>currentDate <span class="token operator">-</span> execDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    timeoutId <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        execDate <span class="token operator">=</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>timeWait<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   _<span class="token punctuation">.</span><span class="token function-variable function">xxx</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       
   <span class="token punctuation">}</span>

    <span class="token keyword">var</span> push <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>push<span class="token punctuation">;</span>

    _<span class="token punctuation">.</span><span class="token function-variable function">mixin</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 遍历undescore 上的所有方法 name-方法名</span>
        _<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">functions</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// console.log(name);</span>
            <span class="token comment">// _[name] = obj[name] =&gt; 扩展自定义方法</span>
            <span class="token keyword">var</span> func <span class="token operator">=</span> _<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">//  第二种方法执行的一个关键</span>
            <span class="token class-name">_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 参数的一个合并</span>
                <span class="token comment">// console.log(this._wrapped,arguments);</span>
                <span class="token comment">/* 第一种方法 */</span>
                <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>_wrapped<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// return chainResult(this, func.apply(_, args));</span>
                <span class="token comment">/* ES6的方式 */</span>
                args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> _<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    _<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/* 全局挂载 */</span>
    root<span class="token punctuation">.</span>_ <span class="token operator">=</span> _<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br></div></div><p>函数式编程库一般都是一种可插拔的方式，可插拔的方式的特点就是代码的核心非常小，但是功能非常丰富。</p> <p>函数式编程的两个特点：</p> <ul><li>通过函数对数据进行转换</li> <li>通过串联多个函数来求结果</li></ul> <p>这里的函数式编程不做讲解，如果想看具体的函数式编程的介绍，可以前往第十一卷。</p> <h2 id="六、前端测试"><a href="#六、前端测试" class="header-anchor">#</a> 六、前端测试</h2> <h3 id="i、e2e测试"><a href="#i、e2e测试" class="header-anchor">#</a> I、e2e测试</h3> <p>测试框架：</p> <p>playWright，微软开源的测试框架，我们来看一下是怎么使用的，要注意的是playWright是没有断言库的，所以我们还要是用chai断言库进行断言：</p> <p>安装chai断言库：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ npm install chai -D
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>安装playWright：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ npm install playWright -D
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>编写测试脚本：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* tests/e2e.test.js */</span>

<span class="token keyword">const</span> playwright <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'playwright'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> expect <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chain'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expect<span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> browserType <span class="token keyword">of</span> <span class="token punctuation">[</span><span class="token string">'chromium'</span><span class="token punctuation">,</span> <span class="token string">'firefox'</span><span class="token punctuation">,</span> <span class="token string">'webkit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> playwright<span class="token punctuation">[</span>browserType<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 测试项目中的图书列表页</span>
    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8000/bookslist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 模拟用户点击</span>
    <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">textContent</span><span class="token punctuation">(</span><span class="token string">&quot;#btn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token string">'点击'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">screenshot</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">report/example-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>browserType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.png</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>编写测试命令（package.json）：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>...
<span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;NODE_ENV=development nodemon --exec 'babel-node ./app.js'&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test:e2e&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node tests/e2e.test.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="ii、前端接口测试"><a href="#ii、前端接口测试" class="header-anchor">#</a> II、前端接口测试</h3> <p>我们在平时的开发中面对后端给我们的接口我们不知道对不对，就需要事先测试一下，这时候我们一般会用psotman进行接口测试，但是如果接口的数量比较多，我们用postman测试是手动测试的，这样会比较浪费时间，所以在前端我们还可以使用接口的自动化测试工具，测试一下后端的接口好不好用。这里我们使用mocha和supertest来进行接口的自动化测试：</p> <p>首先安装mocha和supertest</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ npm install mocha -D

$ npm install supertest -
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>安装完成之后我们来编写测试脚本：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* tests/api.test.js */</span>

<span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'supertest'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'nodejs api test'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'获取图书列表接口'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8000'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'api/getBooksList'</span><span class="token punctuation">)</span>
    	<span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
    	<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'res---&gt;'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>编写完之后我们还要添加一个测试接口的命令：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>...
<span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;NODE_ENV=development nodemon --exec 'babel-node ./app.js'&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test:e2e&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node tests/e2e.test.js&quot;</span><span class="token punctuation">,</span>
  	<span class="token property">&quot;test:api&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mocha --file ./tests/api.test.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>另外接口测试还可以搭配断言库，来检查返回数据的长度，以及返回数据的格式是否正确。</p> <h2 id="七、总结"><a href="#七、总结" class="header-anchor">#</a> 七、总结</h2> <p>BFF架构的实现，到这里也就告一段落了，但这也知识核心的实现部分，还有许多工作要完善。 比如如果要上线的话，Node项目的上线，维护等工作。这就需要PM2来做进程管理和负载均衡。还有就是webpack的打包，这一点很重要我们会在以后慢慢的细化。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/L-SUI/note/edit/master/docs/note/server/bff2.md" target="_blank" rel="noopener noreferrer">在 Github 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">8/4/2022, 5:55:00 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/server/bff1.html" class="prev">
        前后端实现BFF架构（一）
      </a></span> <span class="next"><a href="/note/server/ioc_bigpipe.html">
        前端架构师启蒙课第一讲-走进IOC
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.414e898e.js" defer></script><script src="/assets/js/2.2b5dec35.js" defer></script><script src="/assets/js/85.d34d3ccf.js" defer></script>
  </body>
</html>
