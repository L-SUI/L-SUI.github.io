<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深度实现Vue SSR原理 | Memory space</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="记忆空间">
    <link rel="preload" href="/assets/css/0.styles.ab177faf.css" as="style"><link rel="preload" href="/assets/js/app.414e898e.js" as="script"><link rel="preload" href="/assets/js/2.2b5dec35.js" as="script"><link rel="preload" href="/assets/js/92.7c05375d.js" as="script"><link rel="prefetch" href="/assets/js/10.cea5db77.js"><link rel="prefetch" href="/assets/js/100.e8f4d692.js"><link rel="prefetch" href="/assets/js/101.591a1bf0.js"><link rel="prefetch" href="/assets/js/102.f3e8101f.js"><link rel="prefetch" href="/assets/js/103.b15b9dc3.js"><link rel="prefetch" href="/assets/js/104.b4e03942.js"><link rel="prefetch" href="/assets/js/105.c942f624.js"><link rel="prefetch" href="/assets/js/106.1f1659e4.js"><link rel="prefetch" href="/assets/js/107.7175b6cf.js"><link rel="prefetch" href="/assets/js/108.3c4927cc.js"><link rel="prefetch" href="/assets/js/109.4ad3b4a5.js"><link rel="prefetch" href="/assets/js/11.cce96b68.js"><link rel="prefetch" href="/assets/js/110.b723c443.js"><link rel="prefetch" href="/assets/js/111.85e41162.js"><link rel="prefetch" href="/assets/js/12.612c7716.js"><link rel="prefetch" href="/assets/js/13.bf9804de.js"><link rel="prefetch" href="/assets/js/14.7f3c0563.js"><link rel="prefetch" href="/assets/js/15.53a9f16c.js"><link rel="prefetch" href="/assets/js/16.a00a2ffd.js"><link rel="prefetch" href="/assets/js/17.75c8bc55.js"><link rel="prefetch" href="/assets/js/18.7be85063.js"><link rel="prefetch" href="/assets/js/19.9795353c.js"><link rel="prefetch" href="/assets/js/20.acaa079e.js"><link rel="prefetch" href="/assets/js/21.66368eab.js"><link rel="prefetch" href="/assets/js/22.8e691c9e.js"><link rel="prefetch" href="/assets/js/23.ef6288d2.js"><link rel="prefetch" href="/assets/js/24.1b1bfe0d.js"><link rel="prefetch" href="/assets/js/25.3c32a8ec.js"><link rel="prefetch" href="/assets/js/26.e8183b8f.js"><link rel="prefetch" href="/assets/js/27.06f00591.js"><link rel="prefetch" href="/assets/js/28.113ea795.js"><link rel="prefetch" href="/assets/js/29.332c2ea3.js"><link rel="prefetch" href="/assets/js/3.2d22cccd.js"><link rel="prefetch" href="/assets/js/30.c0e24ce3.js"><link rel="prefetch" href="/assets/js/31.d343c693.js"><link rel="prefetch" href="/assets/js/32.35bfc8eb.js"><link rel="prefetch" href="/assets/js/33.c7878a02.js"><link rel="prefetch" href="/assets/js/34.264850c5.js"><link rel="prefetch" href="/assets/js/35.1544c6da.js"><link rel="prefetch" href="/assets/js/36.1ed171c5.js"><link rel="prefetch" href="/assets/js/37.d715c829.js"><link rel="prefetch" href="/assets/js/38.6807fe0d.js"><link rel="prefetch" href="/assets/js/39.090178f2.js"><link rel="prefetch" href="/assets/js/4.bd0ac780.js"><link rel="prefetch" href="/assets/js/40.07c06c4b.js"><link rel="prefetch" href="/assets/js/41.66eb3a2e.js"><link rel="prefetch" href="/assets/js/42.96914832.js"><link rel="prefetch" href="/assets/js/43.e252f7dd.js"><link rel="prefetch" href="/assets/js/44.f2350798.js"><link rel="prefetch" href="/assets/js/45.af043aaf.js"><link rel="prefetch" href="/assets/js/46.e7590fb9.js"><link rel="prefetch" href="/assets/js/47.4baf33f1.js"><link rel="prefetch" href="/assets/js/48.78e9872d.js"><link rel="prefetch" href="/assets/js/49.108aba5c.js"><link rel="prefetch" href="/assets/js/5.b6df23a7.js"><link rel="prefetch" href="/assets/js/50.b39f62fc.js"><link rel="prefetch" href="/assets/js/51.c20680ba.js"><link rel="prefetch" href="/assets/js/52.4e7df985.js"><link rel="prefetch" href="/assets/js/53.c1d11e72.js"><link rel="prefetch" href="/assets/js/54.b2abb2d3.js"><link rel="prefetch" href="/assets/js/55.ab694255.js"><link rel="prefetch" href="/assets/js/56.551b8404.js"><link rel="prefetch" href="/assets/js/57.ebcce9cb.js"><link rel="prefetch" href="/assets/js/58.b9ac1e6e.js"><link rel="prefetch" href="/assets/js/59.aa33affa.js"><link rel="prefetch" href="/assets/js/6.b81681ba.js"><link rel="prefetch" href="/assets/js/60.84b621ed.js"><link rel="prefetch" href="/assets/js/61.dac79e08.js"><link rel="prefetch" href="/assets/js/62.a7b190c4.js"><link rel="prefetch" href="/assets/js/63.69909b9b.js"><link rel="prefetch" href="/assets/js/64.d6e03a62.js"><link rel="prefetch" href="/assets/js/65.684a2814.js"><link rel="prefetch" href="/assets/js/66.44c4cd5e.js"><link rel="prefetch" href="/assets/js/67.686903ae.js"><link rel="prefetch" href="/assets/js/68.ba59f8c5.js"><link rel="prefetch" href="/assets/js/69.f9c5422f.js"><link rel="prefetch" href="/assets/js/7.bd992b3d.js"><link rel="prefetch" href="/assets/js/70.4a5a5e5b.js"><link rel="prefetch" href="/assets/js/71.b9ee7b87.js"><link rel="prefetch" href="/assets/js/72.dc106525.js"><link rel="prefetch" href="/assets/js/73.481683ea.js"><link rel="prefetch" href="/assets/js/74.3dc3b39a.js"><link rel="prefetch" href="/assets/js/75.337c8c6d.js"><link rel="prefetch" href="/assets/js/76.88cb64ac.js"><link rel="prefetch" href="/assets/js/77.5c705847.js"><link rel="prefetch" href="/assets/js/78.b1988d9d.js"><link rel="prefetch" href="/assets/js/79.05712423.js"><link rel="prefetch" href="/assets/js/8.60f4381c.js"><link rel="prefetch" href="/assets/js/80.cb16545c.js"><link rel="prefetch" href="/assets/js/81.452509cd.js"><link rel="prefetch" href="/assets/js/82.5da948ad.js"><link rel="prefetch" href="/assets/js/83.6bc21179.js"><link rel="prefetch" href="/assets/js/84.85317d6f.js"><link rel="prefetch" href="/assets/js/85.d34d3ccf.js"><link rel="prefetch" href="/assets/js/86.95012de3.js"><link rel="prefetch" href="/assets/js/87.c9ff9779.js"><link rel="prefetch" href="/assets/js/88.1615b8fc.js"><link rel="prefetch" href="/assets/js/89.ffec0272.js"><link rel="prefetch" href="/assets/js/9.d57dabe4.js"><link rel="prefetch" href="/assets/js/90.20781978.js"><link rel="prefetch" href="/assets/js/91.030a0b2a.js"><link rel="prefetch" href="/assets/js/93.8bd58035.js"><link rel="prefetch" href="/assets/js/94.2a0b660f.js"><link rel="prefetch" href="/assets/js/95.8837c612.js"><link rel="prefetch" href="/assets/js/96.9196c31f.js"><link rel="prefetch" href="/assets/js/97.b03bbd6f.js"><link rel="prefetch" href="/assets/js/98.0da533a2.js"><link rel="prefetch" href="/assets/js/99.6194f1ed.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ab177faf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Memory space</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/L-SUI/note/tree/master/every" target="_blank" rel="noopener noreferrer" class="nav-link external">
  每日
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/L-SUI/note/tree/master/LeetCode/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="友邻" class="dropdown-title"><span class="title">友邻</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://notes.itzkp.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  朱昆鹏
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/L-SUI/note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/L-SUI/note/tree/master/every" target="_blank" rel="noopener noreferrer" class="nav-link external">
  每日
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/L-SUI/note/tree/master/LeetCode/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="友邻" class="dropdown-title"><span class="title">友邻</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://notes.itzkp.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  朱昆鹏
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/L-SUI/note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>源码解析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>你不知道的css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构与算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Server</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/server/bff1.html" class="sidebar-link">前后端实现BFF架构（一）</a></li><li><a href="/note/server/bff2.html" class="sidebar-link">前后端实现BFF架构（二）</a></li><li><a href="/note/server/ioc_bigpipe.html" class="sidebar-link">前端架构师启蒙课第一讲-走进IOC</a></li><li><a href="/note/server/mvc.html" class="sidebar-link">前端架构分离之后端开发</a></li><li><a href="/note/server/mysql.html" class="sidebar-link">Mysql 初探</a></li><li><a href="/note/server/node.html" class="sidebar-link">NodeJS 初探</a></li><li><a href="/note/server/node_optimization.html" class="sidebar-link">NodeJS 性能调优</a></li><li><a href="/note/server/pm2.html" class="sidebar-link">PM2</a></li><li><a href="/note/server/vue_ssr.html" aria-current="page" class="active sidebar-link">深度实现Vue SSR原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/server/vue_ssr.html#零、写在前面" class="sidebar-link">零、写在前面</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/server/vue_ssr.html#一、什么是ioc、di、aop？" class="sidebar-link">一、什么是IOC、DI、AOP？</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/server/vue_ssr.html#二、实战改造" class="sidebar-link">二、实战改造</a></li><li class="sidebar-sub-header"><a href="/note/server/vue_ssr.html#三、总结" class="sidebar-link">三、总结</a></li></ul></li><li><a href="/note/server/webpack_bff.html" class="sidebar-link">Webpack从0-1深度细化BFF（一）</a></li><li><a href="/note/server/webpack_bff2.html" class="sidebar-link">Webpack从0-1深度细化BFF（二）</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>OS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>常用工具</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>自动化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>js相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>QA相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>文章收藏</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="深度实现vue-ssr原理"><a href="#深度实现vue-ssr原理" class="header-anchor">#</a> 深度实现Vue SSR原理</h1> <h2 id="零、写在前面"><a href="#零、写在前面" class="header-anchor">#</a> 零、写在前面</h2> <p>首先，这篇文章探讨的并不是Vue SSR这个框架，而是探讨它的原理。这次的实战也是从上次的实战基础上进行扩展和重构。我们上次实战的内容是把BFF架构的前后端代码分别使用webpack和gulp进行了打包处理。</p> <p>我们的BFF架构的项目实战，整体上使用的是MVC的设计模式。MVC的优点在于简单易懂，对于程序员的心智负担不是很重。而且我们大多数的业务都可以做成MVC的模式。但是它的劣势也显而易见，MVC三者之间的耦合度是相当高的，相互之间的嵌套也太深，只要一个出现了问题那么整个程序就会崩溃。</p> <p>为了不出现上述的情况，我们需要把MVC改成IOC（控制反转），IOC使用的技术手段叫DI（依赖注入）。这中设计模式和技术手段最早是由Java的Struct和Spring提出的。依赖注入的概念在前端框架<strong>Angular</strong>中也有应用。利用了AOP（面向切面）的编程思想，使用DI来实现了IOC。</p> <h3 id="一、什么是ioc、di、aop？"><a href="#一、什么是ioc、di、aop？" class="header-anchor">#</a> 一、什么是IOC、DI、AOP？</h3> <ul><li><p>**IOC（Inversion Of Control）：**控制反转。是获取对象的方式，由原来的主动获取，转变为被动接收。是Spring框架用于创建对象和管理对象的容器。IOC是工厂模式的体现。</p></li> <li><p>**DI（Dependency Injection）：**依赖注入。它是Spring框架核心IOC的具体实现。我们在编写程序代码时，通过控制反转，把对象交给Spring管理。但是代码中必然会存在一定的依赖关系。比如在业务层中需要引入持久层对象，这种层与层之间ctx的关系，我们也交给Spring来维护。<strong>简单来说：依赖注入就是通过类的构造方法给类的成员变量赋值。</strong></p></li> <li><p><strong>AOP（Aspect Oriented Programming）</strong>，即面向切面编程。通过预编译方式和运行期动态代理实现程序功能的统一维护的一种技术。AOP是OOP的延续，是软件系统开发中的一个热点，也是spring框架的一个重点。利用AOP可以实现业务逻辑各个部分的隔离，从而使得业务逻辑各个部分的耦合性降低，提高程序的可重用性，同时提高开发效率。</p> <p><strong>简单理解：aop是面向切面编程，是使用动态代理技术，实现在不修改java源代码的情况下，运行时实现方法功能的增强。</strong></p></li></ul> <h2 id="二、实战改造"><a href="#二、实战改造" class="header-anchor">#</a> 二、实战改造</h2> <p>我们了解IOC、DI、AOP的概念之后，就要上手改造我们上次完成的BFF项目。</p> <p><strong>首先我们要解决的第一个问题就是，我们要在路由层面判断是在站内切换的，还是用户刷新？</strong></p> <ul><li>第一，我们需要判断这个路由是站内切换还是直接落地。</li> <li>第二，针对这两种情况我们做不同的处理：
<ul><li>站内切换：我们为了避免资源的重复加载，直接返回一个json</li> <li>直接落地：如果是页面直接落地，包括用户刷新页面，那么就正常调用render函数，直接渲染页面。</li></ul></li> <li>第三，我们要考虑到一个严重的问题，那就是如果是直接渲染页面，数据量会很大，为了解决这个问题可以使用<code>Bigpip</code>进行分片加载。</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// /src/server/controllers/BookController.js</span>

<span class="token keyword">import</span> Controller <span class="token keyword">from</span> <span class="token string">'./Controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> BooksModel <span class="token keyword">from</span> <span class="token string">'../models/BooksModel'</span>

<span class="token keyword">class</span> <span class="token class-name">BooksController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">actionBooksListPage</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> booksModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BooksModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> booksModel<span class="token punctuation">.</span><span class="token function">getBookList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'books/pages/list'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> data<span class="token operator">:</span> result<span class="token punctuation">.</span>data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">actionBooksCreatePage</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先写一点伪代码，说明逻辑</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>站内切换<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 不要重复加载资源，需要什么就加载什么。</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// 直接落地或者强制刷新，资源全部加载。</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'books/pages/create'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> BooksController<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>那么我们现在面临的第一个问题就是：<strong>如何判断是站内切换还是直接落地？</strong></p> <p>需要使用到一个库：<code>pajax</code>，什么是pjax，pjax = pushState + ajax。pjax 的实现是利用 HTML5 的 pushState() 和 replaceState() 新特性和 ajax 结合实现。pushState() 和 replaceState() 用来操作 State（状态）对象，即可添加和修改历史记录，进而更新 url 和提供前进、后退操作 ajax 实现数据的异步加载进而局部刷新。</p> <p>使用pjax监听代理a连接，如果点击a连接，请求头中会增加几个参数：</p> <ul><li>X-PJAX: true</li> <li>X-PJAX-Container:  #app</li></ul> <p>其中我们使用到的就是<code>x-pjax</code>这个参数，如果是点击a连接，也就是说为站内切换，x-pjax就位true。如果是直接落到页面上，那么请求头中就不会存在这个x-pjax参数。</p> <p>解释完判断依据之后我们上代码，先来看一下如果在页面中代理掉所有的a连接：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 改造一下src/web/views/layouts/layout.html --&gt;</span>
<span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>{% block title %}{% endblock %}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  {% block head %}{% endblock %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  {% include '../../components/nav/nav.html' %}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    {% block content %}{% endblock %}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcdn.net/ajax/libs/jquery.pjax/2.0.1/jquery.pjax.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pjax</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'#app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  {% block script %}{% endblock %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>在代码中我们可以知道，pjax需要依赖jquery，所以我们要先引入jquery，再引入pjax。然后用div把要动态渲染的dom结构包裹起来，并设置id为app，读到这里我们观察一下代码是不是有Vue的味道了？其实这就是<strong>Vue SSR的核心实现</strong>。最后一步就是把整个页面的a连接用pjax代理。（<strong>注：这里需要说明一点，我们一定要在layout.html中做代理，因为整站所有的页面都继承了layout.html。所以只有在layout.html中才能得到页面中的所有a链接。</strong>）</p> <p>代理完a连接之后，我们开始处理<code>BooksController.js</code>：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// /src/server/controllers/BookController.js</span>

<span class="token keyword">import</span> Controller <span class="token keyword">from</span> <span class="token string">'./Controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> BooksModel <span class="token keyword">from</span> <span class="token string">'../models/BooksModel'</span>

<span class="token keyword">class</span> <span class="token class-name">BooksController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">actionBooksListPage</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> booksModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BooksModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> booksModel<span class="token punctuation">.</span><span class="token function">getBookList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 我们把逻辑写到图书列表页，有真实的数据可以渲染，会比较有趣</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>header<span class="token punctuation">[</span><span class="token string">'x-pjax'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 不要重复加载资源，需要什么就加载什么。</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'站内切换'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// 直接落地或者强制刷新，资源全部加载。</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'直接落地'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'books/pages/list'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> data<span class="token operator">:</span> result<span class="token punctuation">.</span>data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">actionBooksCreatePage</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'books/pages/create'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> BooksController<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>我们利用了pjax在站内跳转会给header添加参数的特性，判断是否是站内跳转还是直接落地，如果是直接落地，我们还是之前的方式，SSR直接渲染。如果是站内跳转，则是按照Vue这种SPA的框架处理，直接渲染改变的内容。</p> <p>我们先来改一下list/index.html：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>pjaxcontent<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
    {% for item in data %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>{{ item.name }} - {{ item.price }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    {% endfor %}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>我们把不变的东西都去掉，值保留列表部分。然后把nva.html在layouts.html中引入，作为网页的公共 部分。这样就可以实现，在站内切换的时候值渲染更改的内容，也就是说当站内切换到<code>boos/list</code>的路由时，只请求list/index.html。</p> <p>现在我们观察一下list/index.html，只保留了列表，而且用div包裹起来并设置pjaxcontent的类名。</p> <p>如果想在切换路由的时候只请求list/index.html，不是全网页重新渲染一遍，我们还要在BooksController中下点工夫。</p> <ul><li><p>我们需要使用到一个服务端渲染的jquery核心实现：cheerio</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">npm</span> <span class="token function">install</span> cheerio
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>只返回改变路由后需要渲染的DOM结构，并不是整个网页直接返回。</p></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// src/server/constrollers/BooksController.js</span>

<span class="token keyword">import</span> Controller <span class="token keyword">from</span> <span class="token string">'./Controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> BooksModel <span class="token keyword">from</span> <span class="token string">'../models/BooksModel'</span><span class="token punctuation">;</span>
<span class="token comment">// 引入cheerio</span>
<span class="token keyword">import</span> cheerio <span class="token keyword">from</span> <span class="token string">'cheerio'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">BooksController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">actionBooksListPage</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> booksModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BooksModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> booksModel<span class="token punctuation">.</span><span class="token function">getBookList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 后端渲染html直接提出来</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'books/pages/list'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> data<span class="token operator">:</span> result<span class="token punctuation">.</span>data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 我们把逻辑写到图书列表页，有真实的数据可以渲染，会比较有趣</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>header<span class="token punctuation">[</span><span class="token string">'x-pjax'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 使用cheerio的load方法，</span>
      <span class="token keyword">const</span> $ <span class="token operator">=</span> cheerio<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;.pjaxcontent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这样就做到了服务器只返回 $(&quot;.pjaxcontent&quot;) 的DOM结构</span>
        ctx<span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// 直接落地或者强制刷新，资源全部加载。</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'直接落地'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">actionBooksCreatePage</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'books/pages/create'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> BooksController<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>这里有写读者可能会有疑问，服务器返回的DOM怎么会渲染到合适的位置呢？这是因为刚才我们在layout.html中做了如下的设置：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 改造一下src/web/views/layouts/layout.html --&gt;</span>
<span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>{% block title %}{% endblock %}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  {% block head %}{% endblock %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  {% include '../../components/nav/nav.html' %}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    {% block content %}{% endblock %}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcdn.net/ajax/libs/jquery.pjax/2.0.1/jquery.pjax.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pjax</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'#app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  {% block script %}{% endblock %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>我们用div#app包裹了需要渲染的<strong>block content</strong>，并且用pjax代理了所有的a连接，并指定a连接返回的内容渲染在id为'app'的容器里面。其他的保持不变。</p> <p>还有一个问题：<strong>既然是SSR，为什么其他的网页内容没有重新的渲染呢？</strong></p> <p>这个问题其实是很好解释的，我们实现的是Vue的SSR，不是传统意义上的服务器渲染。我们的目的就是把普通的SSR和现在市面上流行的SPA框架，比如Vue和React的单页面渲染结合。实现局部渲染。而且上文中我们在解释pjax原理的时候也说了，<strong>pjax 的实现是利用 HTML5 的 pushState() 和 replaceState() 新特性和 ajax 结合实现。pushState() 和 replaceState() 用来操作 State（状态）对象，即可添加和修改历史记录，进而更新 url 和提供前进、后退操作 ajax 实现数据的异步加载进而局部刷新。</strong></p> <p>所以本质上pjax的路由改变本质上和SPA路由的切换实际上没什么不同，是不会触发网页的跳转的。</p> <p>我们在改造完这些的时候会发现一个问题，在切换到<code>book/list</code>，会出现404的情况，这是使用pjax会出现的正常情况，这样就要求我们在返回DOM之前设置一下http的状态：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// src/server/constrollers/BooksController.js</span>

<span class="token keyword">import</span> Controller <span class="token keyword">from</span> <span class="token string">'./Controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> BooksModel <span class="token keyword">from</span> <span class="token string">'../models/BooksModel'</span><span class="token punctuation">;</span>
<span class="token comment">// 引入cheerio</span>
<span class="token keyword">import</span> cheerio <span class="token keyword">from</span> <span class="token string">'cheerio'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">BooksController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">actionBooksListPage</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> booksModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BooksModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> booksModel<span class="token punctuation">.</span><span class="token function">getBookList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 后端渲染html直接提出来</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'books/pages/list'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> data<span class="token operator">:</span> result<span class="token punctuation">.</span>data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 手动设置请求状态和content-type</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'html'</span><span class="token punctuation">;</span>
    <span class="token comment">// 我们把逻辑写到图书列表页，有真实的数据可以渲染，会比较有趣</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>header<span class="token punctuation">[</span><span class="token string">'x-pjax'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 使用cheerio的load方法，</span>
      <span class="token keyword">const</span> $ <span class="token operator">=</span> cheerio<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;.pjaxcontent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这样就做到了服务器只返回 $(&quot;.pjaxcontent&quot;) 的DOM结构</span>
        ctx<span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// 直接落地或者强制刷新，资源全部加载。</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'直接落地'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">actionBooksCreatePage</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'books/pages/create'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> BooksController<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>到这里我们就基本完成了对Vue SSR的原理实现，实现了在切页的时候只需要ajax请求改变的数据，然后完成替换。这也是Vue SSR的核心原理。现在最后一步就是对模板进行设置：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// src/server/app.js</span>

<span class="token operator">...</span>

<span class="token comment">// 第一步，我们要把historyApiFallBack干掉，这里就不需要配合Vue的假路由了。</span>

app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>render <span class="token operator">=</span> co<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 模板文件的路径和是否缓存尽量的放在配置文件中，可以随意配置。</span>
  root<span class="token operator">:</span> config<span class="token punctuation">.</span>viewsDir<span class="token punctuation">,</span>
  cache<span class="token operator">:</span> config<span class="token punctuation">.</span>cache<span class="token punctuation">,</span>
  <span class="token comment">// 设置writeBody: false</span>
  writeBody<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

errorHandle<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">initController</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">server is running at http://loaclhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>在文档中关于<code>writeBody: false</code>是这么解释的：**writeBody: default(true) auto write body and response.**设置为false是为了缓存（其实这一点我也没弄明白，关于koa-swig的文档实在太少，没查到）。</p> <p>最后我们来看一下直接落地页和站内切换有什么不同：</p> <ul><li><p>传统的直接落地页面</p> <img src="/server/24.png" alt="node-app.png" style="zoom:100%;"> <p>我们可以看到完全是把页面用到的所有的资源全部加载了一遍。</p></li> <li><p>实现了Vue SSR原理的栈内切页</p> <img src="/server/25.png" alt="node-app.png" style="zoom:100%;"> <p>我们可以看到在站内切页的时候只有一个请求，而且这个请求是个xhr请求，也就是ajax请求，请求的返回值就是要替换的DOM结构。</p></li></ul> <p>说到这里我们已经把Vue SSR的原理实现完了，其实很简单，纯手写不利用任何的Vue和React的框架就能完全把Vue SSR的原理实现出来，这种方式把单页应用和后端渲染的多页应用的优点集于一身。主要解决了以下几个问题：</p> <ul><li>SPA首页加载慢的问题</li> <li>传统SSR资源重复加载的问题</li> <li>SPA不利于SEO的问题</li></ul> <h2 id="三、总结"><a href="#三、总结" class="header-anchor">#</a> 三、总结</h2> <p>其实Vue的SSR主要是兼顾了传统SSR和SPA的优点，既可以分片渲染，直接替换内容而不是重新渲染整个网页。今天我们实现的就是Next.js和Nuxt.js的原理，并没有什么神奇的。</p> <p>总结一下我们实现Vue SSR的流程：</p> <ul><li>在全局的页面（我们这里是layout.html）中引入<code>jquery.js</code>和<code>pjax.js</code>两个文件。</li> <li>用<code>div#app</code>包裹渲染的内容部分。</li> <li>编写JS代理全部的a链接到<strong>div#app</strong>。<code>$(document).pjax('a', '#app');</code></li> <li>改写views中的页面，把creat、list、home这几个页面全都变为组件，写入component中，并引入到pages中的页面中。</li> <li>然后将components中的页面内容用<code>div.pjaxcontent</code>包裹起来。</li> <li>改写Conteoller，每一个路由都分直接落地和站内切换两种情况渲染。这里需要注意的是，使用pjax返回的时候我们需要手动修改返回的状态和类型，否则会报404。
<ul><li>直接落地页：<code>ctx.body = await ctx.render('books/pages/list', { data: result.data });</code></li> <li>站内切页：使用cheerio拿出组件中<strong>div.pjaxcontent</strong>的内容（一般是DOM结构），直接作为Ajax的返回值。</li></ul></li> <li>这样做之后，站内切页的返回值自然会被pjax库处理渲染在<code>div#app</code>里面。</li> <li>配置app.js中的swig模板配置，添加<code>writeBody: false</code>。</li></ul> <p>至此，有关于Node + koa 实现Vue SSR原理的内容已经全部写完了，接下来会用TS重构。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/L-SUI/note/edit/master/docs/note/server/vue_ssr.md" target="_blank" rel="noopener noreferrer">在 Github 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">8/4/2022, 5:55:00 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/server/pm2.html" class="prev">
        PM2
      </a></span> <span class="next"><a href="/note/server/webpack_bff.html">
        Webpack从0-1深度细化BFF（一）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.414e898e.js" defer></script><script src="/assets/js/2.2b5dec35.js" defer></script><script src="/assets/js/92.7c05375d.js" defer></script>
  </body>
</html>
