<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Webpack从0-1深度细化BFF（一） | Memory space</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="记忆空间">
    <link rel="preload" href="/assets/css/0.styles.ab177faf.css" as="style"><link rel="preload" href="/assets/js/app.2cd41511.js" as="script"><link rel="preload" href="/assets/js/2.2b5dec35.js" as="script"><link rel="preload" href="/assets/js/92.f297ed2d.js" as="script"><link rel="prefetch" href="/assets/js/10.81c971f0.js"><link rel="prefetch" href="/assets/js/100.1521647d.js"><link rel="prefetch" href="/assets/js/101.aaf828b7.js"><link rel="prefetch" href="/assets/js/102.da083611.js"><link rel="prefetch" href="/assets/js/103.4a071b90.js"><link rel="prefetch" href="/assets/js/104.c4ebd09e.js"><link rel="prefetch" href="/assets/js/105.c5874388.js"><link rel="prefetch" href="/assets/js/106.539ed59f.js"><link rel="prefetch" href="/assets/js/107.4598ee91.js"><link rel="prefetch" href="/assets/js/108.77b29521.js"><link rel="prefetch" href="/assets/js/11.8a8f4c12.js"><link rel="prefetch" href="/assets/js/12.f0b8f41c.js"><link rel="prefetch" href="/assets/js/13.0d422ed2.js"><link rel="prefetch" href="/assets/js/14.bc94f0a8.js"><link rel="prefetch" href="/assets/js/15.f86eeda2.js"><link rel="prefetch" href="/assets/js/16.5fe50e37.js"><link rel="prefetch" href="/assets/js/17.75c8bc55.js"><link rel="prefetch" href="/assets/js/18.7be85063.js"><link rel="prefetch" href="/assets/js/19.92f5fbe7.js"><link rel="prefetch" href="/assets/js/20.6be8ad1d.js"><link rel="prefetch" href="/assets/js/21.66368eab.js"><link rel="prefetch" href="/assets/js/22.8e691c9e.js"><link rel="prefetch" href="/assets/js/23.dd65c8e7.js"><link rel="prefetch" href="/assets/js/24.1b1bfe0d.js"><link rel="prefetch" href="/assets/js/25.98f2fc2c.js"><link rel="prefetch" href="/assets/js/26.7a673c57.js"><link rel="prefetch" href="/assets/js/27.a54e4d95.js"><link rel="prefetch" href="/assets/js/28.786f014f.js"><link rel="prefetch" href="/assets/js/29.332c2ea3.js"><link rel="prefetch" href="/assets/js/3.56b12585.js"><link rel="prefetch" href="/assets/js/30.36c767dc.js"><link rel="prefetch" href="/assets/js/31.cb12c96e.js"><link rel="prefetch" href="/assets/js/32.f80e34ce.js"><link rel="prefetch" href="/assets/js/33.f85f82f5.js"><link rel="prefetch" href="/assets/js/34.7811f981.js"><link rel="prefetch" href="/assets/js/35.1544c6da.js"><link rel="prefetch" href="/assets/js/36.1ed171c5.js"><link rel="prefetch" href="/assets/js/37.5d0c5cae.js"><link rel="prefetch" href="/assets/js/38.6807fe0d.js"><link rel="prefetch" href="/assets/js/39.bcdee173.js"><link rel="prefetch" href="/assets/js/4.bd0ac780.js"><link rel="prefetch" href="/assets/js/40.c9d400db.js"><link rel="prefetch" href="/assets/js/41.cd3247ba.js"><link rel="prefetch" href="/assets/js/42.3034f9eb.js"><link rel="prefetch" href="/assets/js/43.312e93c5.js"><link rel="prefetch" href="/assets/js/44.b323427f.js"><link rel="prefetch" href="/assets/js/45.af043aaf.js"><link rel="prefetch" href="/assets/js/46.343353fb.js"><link rel="prefetch" href="/assets/js/47.b83115e0.js"><link rel="prefetch" href="/assets/js/48.78e9872d.js"><link rel="prefetch" href="/assets/js/49.108aba5c.js"><link rel="prefetch" href="/assets/js/5.b6df23a7.js"><link rel="prefetch" href="/assets/js/50.b39f62fc.js"><link rel="prefetch" href="/assets/js/51.bfeb24c6.js"><link rel="prefetch" href="/assets/js/52.9aee6a6f.js"><link rel="prefetch" href="/assets/js/53.35de56d1.js"><link rel="prefetch" href="/assets/js/54.99252d92.js"><link rel="prefetch" href="/assets/js/55.efd7d0e6.js"><link rel="prefetch" href="/assets/js/56.e65cb2e4.js"><link rel="prefetch" href="/assets/js/57.441b87e5.js"><link rel="prefetch" href="/assets/js/58.23ade225.js"><link rel="prefetch" href="/assets/js/59.b5967c6c.js"><link rel="prefetch" href="/assets/js/6.f61b7bed.js"><link rel="prefetch" href="/assets/js/60.4018c6be.js"><link rel="prefetch" href="/assets/js/61.dac79e08.js"><link rel="prefetch" href="/assets/js/62.49cea4c9.js"><link rel="prefetch" href="/assets/js/63.571b44cb.js"><link rel="prefetch" href="/assets/js/64.2aeb40c6.js"><link rel="prefetch" href="/assets/js/65.e852bf58.js"><link rel="prefetch" href="/assets/js/66.0df777a6.js"><link rel="prefetch" href="/assets/js/67.00334440.js"><link rel="prefetch" href="/assets/js/68.4e42a03a.js"><link rel="prefetch" href="/assets/js/69.f9c5422f.js"><link rel="prefetch" href="/assets/js/7.2d4dd5d4.js"><link rel="prefetch" href="/assets/js/70.8f7f442b.js"><link rel="prefetch" href="/assets/js/71.b9ee7b87.js"><link rel="prefetch" href="/assets/js/72.dc106525.js"><link rel="prefetch" href="/assets/js/73.b9188cc1.js"><link rel="prefetch" href="/assets/js/74.3dc3b39a.js"><link rel="prefetch" href="/assets/js/75.315be207.js"><link rel="prefetch" href="/assets/js/76.88cb64ac.js"><link rel="prefetch" href="/assets/js/77.a270576b.js"><link rel="prefetch" href="/assets/js/78.944d3ffc.js"><link rel="prefetch" href="/assets/js/79.19a1834b.js"><link rel="prefetch" href="/assets/js/8.60f4381c.js"><link rel="prefetch" href="/assets/js/80.cb16545c.js"><link rel="prefetch" href="/assets/js/81.8547844a.js"><link rel="prefetch" href="/assets/js/82.8ce4070b.js"><link rel="prefetch" href="/assets/js/83.65d21fc3.js"><link rel="prefetch" href="/assets/js/84.20857bd1.js"><link rel="prefetch" href="/assets/js/85.ee10bc52.js"><link rel="prefetch" href="/assets/js/86.08956214.js"><link rel="prefetch" href="/assets/js/87.ed4a257f.js"><link rel="prefetch" href="/assets/js/88.bfafeaf0.js"><link rel="prefetch" href="/assets/js/89.13efefee.js"><link rel="prefetch" href="/assets/js/9.dd058083.js"><link rel="prefetch" href="/assets/js/90.2e10ee3e.js"><link rel="prefetch" href="/assets/js/91.9862c397.js"><link rel="prefetch" href="/assets/js/93.c528df0f.js"><link rel="prefetch" href="/assets/js/94.b75ef84a.js"><link rel="prefetch" href="/assets/js/95.0443557a.js"><link rel="prefetch" href="/assets/js/96.5149e454.js"><link rel="prefetch" href="/assets/js/97.c54a0e71.js"><link rel="prefetch" href="/assets/js/98.05c3e9b1.js"><link rel="prefetch" href="/assets/js/99.24a9fe86.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ab177faf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Memory space</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/L-SUI/note/tree/master/every" target="_blank" rel="noopener noreferrer" class="nav-link external">
  每日
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/L-SUI/note/tree/master/LeetCode/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="友邻" class="dropdown-title"><span class="title">友邻</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://notes.itzkp.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  朱昆鹏
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/L-SUI/note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/L-SUI/note/tree/master/every" target="_blank" rel="noopener noreferrer" class="nav-link external">
  每日
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/L-SUI/note/tree/master/LeetCode/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="友邻" class="dropdown-title"><span class="title">友邻</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://notes.itzkp.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  朱昆鹏
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/L-SUI/note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>源码解析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>你不知道的css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构与算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Server</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/server/bff1.html" class="sidebar-link">前后端实现BFF架构（一）</a></li><li><a href="/note/server/bff2.html" class="sidebar-link">前后端实现BFF架构（二）</a></li><li><a href="/note/server/ioc_bigpipe.html" class="sidebar-link">前端架构师启蒙课第一讲-走进IOC</a></li><li><a href="/note/server/mvc.html" class="sidebar-link">前端架构分离之后端开发</a></li><li><a href="/note/server/mysql.html" class="sidebar-link">Mysql 初探</a></li><li><a href="/note/server/node.html" class="sidebar-link">NodeJS 初探</a></li><li><a href="/note/server/node_optimization.html" class="sidebar-link">NodeJS 性能调优</a></li><li><a href="/note/server/pm2.html" class="sidebar-link">PM2</a></li><li><a href="/note/server/vue_ssr.html" class="sidebar-link">深度实现Vue SSR原理</a></li><li><a href="/note/server/webpack_bff.html" aria-current="page" class="active sidebar-link">Webpack从0-1深度细化BFF（一）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/server/webpack_bff.html#零、写在前面" class="sidebar-link">零、写在前面</a></li><li class="sidebar-sub-header"><a href="/note/server/webpack_bff.html#一、web-conponents" class="sidebar-link">一、Web Conponents</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/server/webpack_bff.html#i、什么是web-components？" class="sidebar-link">I、什么是Web Components？</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/server/webpack_bff.html#ii、为什么要使用web-coponents？" class="sidebar-link">II、为什么要使用Web Coponents？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/server/webpack_bff.html#iii、兼容性" class="sidebar-link">III、兼容性</a></li><li class="sidebar-sub-header"><a href="/note/server/webpack_bff.html#iv、实践者" class="sidebar-link">IV、实践者</a></li><li class="sidebar-sub-header"><a href="/note/server/webpack_bff.html#v、相关框架" class="sidebar-link">V、相关框架</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/server/webpack_bff.html#二、bff项目架构的工程化改造" class="sidebar-link">二、BFF项目架构的工程化改造</a></li><li class="sidebar-sub-header"><a href="/note/server/webpack_bff.html#三、工程化改造具体步骤" class="sidebar-link">三、工程化改造具体步骤</a></li></ul></li><li><a href="/note/server/webpack_bff2.html" class="sidebar-link">Webpack从0-1深度细化BFF（二）</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>OS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>常用工具</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>自动化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>js相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>QA相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>文章收藏</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="webpack从0-1深度细化bff（一）"><a href="#webpack从0-1深度细化bff（一）" class="header-anchor">#</a> Webpack从0-1深度细化BFF（一）</h1> <h2 id="零、写在前面"><a href="#零、写在前面" class="header-anchor">#</a> 零、写在前面</h2> <p>这篇文章承接上文的<strong>前后端实现BFF架构</strong>来深度探讨一下BFF的另一些内容，以及前端的一些较为新颖的技术实现。</p> <p>我们将会探讨下列问题：</p> <ul><li>Web Components：<a href="https://developer.mozilla.org/zh-CN/docs/Web/Web_Components" target="_blank" rel="noopener noreferrer">MDN文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>BFF项目架构的工程化改造</li></ul> <h2 id="一、web-conponents"><a href="#一、web-conponents" class="header-anchor">#</a> 一、Web Conponents</h2> <p>前端最近出现了一种浏览器原生支持的web组件，就像Vue组件和React组件类似，不同的是Vue和React的组件需要经过模板编译器编译成浏览器能够识别的HTML和CSS、JS，然后渲染在浏览器中。但是WebComponents是浏览器天然能够识别的web组件。</p> <h3 id="i、什么是web-components？"><a href="#i、什么是web-components？" class="header-anchor">#</a> I、什么是Web Components？</h3> <p>这是我们探讨Web Components的第一个问题。**Web Components 是一套不同的技术，允许您创建可重用的定制元素（它们的功能封装在您的代码之外）并且在您的web应用中使用它们。**这句话很好的揭示了什么是Web Components。就是我们所说的类似于Reac和Vue组件的原生Web组件。这里的原生是指可以不经过任何的编译浏览器就能直接渲染。</p> <h2 id="ii、为什么要使用web-coponents？"><a href="#ii、为什么要使用web-coponents？" class="header-anchor">#</a> II、为什么要使用Web Coponents？</h2> <p>作为软件开发者我们肯定知道这么一句话：Don't Repeat Youerself！我们都要尽可能的重用代码，工程中尽量少的出现重复性的代码（当然这也是代码质量检测的一个重要的方面）。</p> <p>Web Coponents由三项技术组成（摘自MDN）：</p> <ul><li><strong>Custom Elements（自定义元素）</strong>：一组JavaScript API，允许您定义custom elements及其行为，然后可以在您的用户界面中按照需要使用它们。</li> <li><strong>Shadow DOM（影子DOM）</strong>：一组JavaScript API，用于将封装的“影子”DOM树附加到元素（与主文档DOM分开呈现）并控制其关联的功能。通过这种方式，您可以保持元素的功能私有，这样它们就可以被脚本化和样式化，而不用担心与文档的其他部分发生冲突。</li> <li><strong>HTML Templates（HTML模板）</strong>：<code>template</code>和<code>slot</code>元素使您可以编写不在呈现页面中显示的标记模板。然后它们可以作为自定义元素结构的基础被多次重用。</li></ul> <h3 id="iii、兼容性"><a href="#iii、兼容性" class="header-anchor">#</a> III、兼容性</h3> <p>Web Componets的兼容性到现在支持的还是挺好的，主流的现代浏览器都是可以使用的，但是如果有同学想在IE下使用，那就是百日做梦。劝使用IE开发的开发者们放弃IE这个垃圾的浏览器。Edge现在也是不支持的，不过Edge正在开发一个实现。</p> <p>总的来说:</p> <ul><li>Firefox(版本63)、Chrome和Opera都默认支持Web组件。</li> <li>Safari支持许多web组件特性，但比上述浏览器少。</li> <li>Edge正在开发一个实现。</li></ul> <h3 id="iv、实践者"><a href="#iv、实践者" class="header-anchor">#</a> IV、实践者</h3> <p>可能会有人提出疑问Web Component能够使用在生产环境吗？毫无疑问这个是可以的。YouTube已经在使用了。</p> <img src="/server/youtube.png" alt="node-app.png" style="zoom:50%;"> <h3 id="v、相关框架"><a href="#v、相关框架" class="header-anchor">#</a> V、相关框架</h3> <p>现在市面上也出现了很多基于Web Components的框架：</p> <ul><li>X-TAG</li> <li>PolymerJS</li> <li>omi</li></ul> <p>前三个是国外的，omi是中国的。有兴趣的可以去了解一下，使用一下。这篇文章也会使用X-TAG来进行页面的编写。</p> <h2 id="二、bff项目架构的工程化改造"><a href="#二、bff项目架构的工程化改造" class="header-anchor">#</a> 二、BFF项目架构的工程化改造</h2> <p>我们在<strong>前后端实现BFF架构</strong>一文中实践了BFF架构，现在我们对BFF的项目进行工程化的改造。使用Webpack对于前端的代码进行编译打包，后端的Node代码使用gulp来打包编译，实现BFF层面的前后端分离。</p> <p>在工程化改造之前给大家推荐几个好用的工具：</p> <ul><li><p><strong>scripty</strong> 这个工具主要是用来优化package.json中的打包命令的。有的时候我们的打包命令不可避免的会很长，这样编写起来不是很方便，有了scripty就可以解决这个问题。</p> <p>在YII的项目中存在一个<code>bin</code>目录，是用来存放执行命令的。我们在BFF项目里面也可以新建一个<code>scripts</code>目录来存放package.json中执行的命令。</p> <p>安装：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ npm install --save-dev scripty
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>随着我们项目越来越复杂，那么随之而来的就是package.json中的scripts命令就会越来越多，为了便于管理我们就要使用scripty。我们来看一下工程化之后的package.json：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;BFF-Project&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MIT&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;client:dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scripty&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;client:prod&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scripty&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;server:dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scripty&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;server:prod&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scripty&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;server:start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scripty&quot;</span><span class="token punctuation">,</span>
    
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;NODE_ENV=development nodemon --delay 500ms --exec 'babel-node ./app.js'&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test:e2e&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node tests/e2e.test.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test:api&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mocha --file ./tests/api.test.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@koa/router&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^10.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;axios&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.21.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;co&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.6.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.13.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa-static&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa-swig&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.2.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa2-connect-history-api-fallback&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.1.3&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;log4js&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.3.0&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@babel/core&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^7.14.5&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;@babel/node&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^7.14.5&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;@babel/preset-env&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^7.14.5&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;chai&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.3.4&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;mocha&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^9.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;playwright&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.12.2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;scripty&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;supertest&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.1.3&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>可以看到我们改写了package.json中的scripts脚本，增加了包含服务端和客户端的一些命令。这样的话我们就可以使用scripty来对.sh脚本进行管理。根据<a href="https://github.com/testdouble/scripty#readme" target="_blank" rel="noopener noreferrer">scripty的使用方法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>我们进行如下操作：</p> <ul><li><p>根据package.json中scripts的配置，我们在项目的script目录里新建client目录和server目录。</p></li> <li><p>在<code>/scripts/client</code>目录中新建dev.sh和prod.sh文件。</p></li> <li><p>在<code>/scripts/server</code>目录中新建dev.sh和prod.sh文件以及start.sh文件。</p></li> <li><p>需要注意的是.sh就是可执行文件，所以我们需要赋给script目录可执行权限。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 执行完这条命令，scripts中的.sh文件就拥有了可执行权限，就可以被直接执行
$ chmod -R +x scripts
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>然后我们做一下测试：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /scripts/client/dev.sh</span>
<span class="token builtin class-name">echo</span> <span class="token string">'hello world'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>执行<code>npm run client:dev</code>，得到如下结果：</p> <img src="/server/01.png" alt="node-app.png" style="zoom:50%;"> <blockquote><p>需要注意的是我们在编写package.json的scripts脚本的时候，<code>start</code>、<code>test</code>、<code>build</code>这三个脚本命令是不要轻易的自定义的，这三个命令一般是上线的时候才运行的。start在生产环境一般是pm2启动，test是测试线上的代码，build是打包生产环境的client端和server端的代码。</p></blockquote> <p>这里着重说一下build和test这两条命令的配置：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;BFF-Project&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MIT&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;client:dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scripty&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;client:prod&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scripty&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;server:dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scripty&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;server:prod&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scripty&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;server:start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scripty&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test:e2e&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scripty&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test:api&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scripty&quot;</span><span class="token punctuation">,</span>

    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pm2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run test:api &amp; npm run test:e2e&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run server:prod &amp; npm run client:prod&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  ...
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>看上面的代码，我们会发现test和build实际上是各自并行的执行了两条命令，这是一种简便的写法，可以简化我们的shell脚本。这里有一个点，两条命令以<code>&amp;</code>连接说明前后两条命令是并行执行，如果以<code>&amp;&amp;</code>连接，前后两条命令是串行执行。</p></li></ul></li></ul> <p>一个重要的概念就是对于package.json来说是有生命周期的，开发者可以决定在某条命令之前执行别的命令：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;BFF-Project&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MIT&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;demo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo demo执行&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;predemo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo demo之前执行&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pm2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run test:api &amp; npm run test:e2e&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run server:prod &amp; npm run client:prod&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  ...
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>我们来运行<code>npm run demo</code>：</p> <img src="/server/02.png" alt="node-app.png" style="zoom:50%;"> <p>我们可以看到先执行了predemo后执行demo。</p> <ul><li><p>第二个工具是<strong>jscpd</strong>，这个工具主要是代码重复率的检查。我们先来安装上：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ npm install jscpd -D
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>和babel差不多需要先配置一个.jscpd.json文件：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;threshold&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;reporters&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;html&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;console&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在配置文件中我们只配置了一个阈值和html报告以及控制台输出。</p> <p>我们创建一个需要测试的JS文件：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// /demo/test.js</span>

<span class="token keyword">function</span> <span class="token function">testFun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'hello world'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">testFun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'hello world'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">testFun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'hello world'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">testFun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'hello world'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>我们可以看到里面全是重复代码，然后我们在package.json中配置测试命令：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;BFF-Project&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MIT&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;demo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo demo执行&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;predemo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo demo之前执行&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pm2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;jscpd&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jscpd './demo/test.js'&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run test:api &amp; npm run test:e2e&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run server:prod &amp; npm run client:prod&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  ...
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>配置完这些我们就可以运行一下测试命令了：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ npm run jscpd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>结果如下图，会输出控制台信息和report HTML，report HTML存储在项目的report目录中：</p> <img src="/server/03.png" alt="node-app.png" style="zoom:50%;"> <p>浏览器打开report中html目录下的index.html可以看到：</p> <img src="/server/04.png" alt="node-app.png" style="zoom:50%;"> <p>控制台和网页都清楚的展示出了被测试的文件代码的重复率。非常直观好用。</p></li></ul> <p><strong>到此为止我们就把工程化改造需要的小工具介绍完了，下面我们正式开始工程化改造。</strong></p> <h2 id="三、工程化改造具体步骤"><a href="#三、工程化改造具体步骤" class="header-anchor">#</a> 三、工程化改造具体步骤</h2> <p>第一步需要我们整理并更改一下项目的目录结构，新建一个src目录，在src中新建两个目录一个是web目录一个是server目录，server目录存放Node服务端的代码，web目录存放前端的代码。</p> <p>服务端的代码包含项目中的以下这些目录和文件：</p> <ul><li><p>app.js</p></li> <li><p>config</p></li> <li><p>controllers</p></li> <li><p>models</p></li> <li><p>middleware</p></li> <li><p>utils</p></li></ul> <p>前端的代码包含项目中以下这些目录：</p> <ul><li>assets</li> <li>components</li> <li>views</li></ul> <p>然后我们删除一些测试生成的报告文件，把report目录整个删除。现在的目录结构如下图：</p> <img src="/server/05.png" alt="node-app.png" style="zoom:50%;"> <p>由于目录结构的变化我们需要改变一些某些文件的路径：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* /src/server/config/index.js */</span>

<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  viewsDir<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../'</span><span class="token punctuation">,</span> <span class="token string">'web/views'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  staticDir<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../'</span><span class="token punctuation">,</span> <span class="token string">'web/assets'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> devConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
    port<span class="token operator">:</span> <span class="token number">8000</span><span class="token punctuation">,</span>
    catch<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  config <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>config<span class="token punctuation">,</span> <span class="token operator">...</span>devConfig <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> prodConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
    port<span class="token operator">:</span> <span class="token number">8080</span><span class="token punctuation">,</span>
    catch<span class="token operator">:</span> <span class="token string">'memory'</span>
  <span class="token punctuation">}</span>
  config <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>config<span class="token punctuation">,</span> <span class="token operator">...</span>prodConfig <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">export</span> <span class="token keyword">default</span> config<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>由于app.js的路径发生了变化，所以执行的命令也要发生响应的变化：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>development nodemon --delay 500ms --exec <span class="token string">'babel-node ./src/server/app.js'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在我们更改完成了，执行一下<code>npm run server:start</code>启动服务。</p> <img src="/server/06.png" alt="node-app.png" style="zoom:50%;"> <p>可以看到可以正常启动，说明我们的目录改造工作已经完成。</p> <p>第二步，我们现在是一个多页应用MPA（many page application）。如果使用webpack打包的话就涉及到一个多入口的问题。</p> <p>首先我们要安装webpack和webpack-cli：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ npm install -D webpack webpack-cli
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们在使用webpack对我们的前端代码进行打包的时候，webpack默认会到项目的根目录下寻找<code>webpack.config.js</code>，所以我们需要在项目根目录新建一个webpack.config.js。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>		<span class="token comment">// 入口 要打包的文件</span>
  output<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>		<span class="token comment">// 出口 打包完成之后输出的文件</span>
  module<span class="token operator">:</span> <span class="token string">&quot;&quot;</span>		<span class="token comment">// 需要打包的模块</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后我们再处理一下web目录中的views目录，把其他的都删掉，处理成<strong>views/books/pages/list.html</strong>这样的层级。在pages目录下新建一个<strong>create.html</strong>。webpack在打包的时候是需要一个js文件作为入口的，所以我们打包多页面应用那么就要给每个页面都配置一个入口的JS文件，这个入口文件是webpack为了更好的处理JS和CSS文件。在views/books目录下新建<strong>books-create.entry.js</strong>和<strong>books-list.entry.js</strong>两个文件作为list.html和create.html的入口文件。<em><em>这里要注意我们所有的入口文件都是</em>.entry.js命名</em>*。配置完这两个入口文件就可以打包了。</p> <p>对于webpack的打包我们也是需要区分环境的，所以webpack的配置也是要和服务端的config是一样的，区分公共配置的不同环境下的私有配置。在项目开发中一般把公共的配置放在<strong>webpack.config.js</strong>中，创建几个不同的webpack配置文件来编写不同环境下个性化的配置。</p> <p>现在我们的项目区分了开发环境和生产环境，所以我们在**/scripts/client**目录中会存在两个脚本dev.sh和prod.sh。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>/* /scripts/client/dev.sh */

webpack --mode development
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>/* /scripts/client/prod.sh */

webpack --mode production
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这是前端webpack打包的命令，webpack利用<code>--mode development</code>的方式进行环境变量的注入，然后在<strong>webpack.config.js</strong>可以拿到，以此区分不同环境下的打包，这个环境变量我们能够使用node的process下的argv来获得：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>

<span class="token comment">// 在webpack.config.js中打印argv</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>打印结果如下：</p> <img src="/server/07.png" alt="node-app.png" style="zoom:80%;"> <p>我们可以看到输出的结果是一个数组，这样的话我们就可以使用下标来获取环境变量。但是这里存在一个问题，在不同的系统下我们得到的数组不同，环境变量在数组中的位置也不同，这就使得用下标获取会出现取错的情况，未解决这个问题我们可以使用一个库，<strong>yargs</strong>。yargs可以把process.argv数组转换为对象。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">npm</span> <span class="token function">install</span> -D yargs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后我们在webpack.config.js中引入并使用：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> argv <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'yargs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><img src="/server/08.png" alt="node-app.png" style="zoom:80%;"> <p>我们可以看到输出是一个对象，我们使用argv.mode就能拿到当前的webpack的环境变量。现在拿到了环境变量就表示我们能够对环境进行代码逻辑的区分了。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> argv <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'yargs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mode <span class="token operator">=</span> argv<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token punctuation">,</span>
  entry<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>		<span class="token comment">// 入口 要打包的文件</span>
  output<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>		<span class="token comment">// 出口 打包完成之后输出的文件</span>
  module<span class="token operator">:</span> <span class="token string">&quot;&quot;</span>		<span class="token comment">// 需要打包的模块</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在webpack中设置mode，wepack会根据mode的环境做不同的处理，比如说如果是development环境代码就不会压缩，如果是production代码就会默认压缩。现在我们正式进行打包环境的区分。为了配置清晰分环境打包的webpack配置文件都放在build目录下，在build目录先新建<code>webpak.development.js</code>、<code>webpack.production.js</code>分别对应开发环境和生产环境。现在开始修改webpack.config.js：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> argv <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'yargs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mode <span class="token operator">=</span> argv<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> envConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./build/webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token punctuation">,</span>
  entry<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>		<span class="token comment">// 入口 要打包的文件</span>
  output<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>		<span class="token comment">// 出口 打包完成之后输出的文件</span>
  module<span class="token operator">:</span> <span class="token string">&quot;&quot;</span>		<span class="token comment">// 需要打包的模块</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>现在webpack.config.js中有两个配置一个是环境的webpack配置，一个是公共配置，这两个配置需要合并在一起，所以我们要使用webpack-merge这个库来完成配置的合并：</p> <p>安装webpack-merge</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">npm</span> <span class="token function">install</span> -D webpack-merge
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>合并webpack配置：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> argv <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'yargs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> merge <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> mode <span class="token operator">=</span> argv<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">;</span>
<span class="token comment">// 分环境加载配置</span>
<span class="token keyword">const</span> envConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./build/webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 公共的webpack配置</span>
<span class="token keyword">const</span> bisicConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token punctuation">,</span>
  entry<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>		<span class="token comment">// 入口 要打包的文件</span>
  output<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>		<span class="token comment">// 出口 打包完成之后输出的文件</span>
  module<span class="token operator">:</span> <span class="token string">&quot;&quot;</span>		<span class="token comment">// 需要打包的模块</span>
<span class="token punctuation">}</span>

<span class="token comment">// 合并配置</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>basicConfig<span class="token punctuation">,</span> envConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>到这里我们就完成了webpack的配置合并。</p> <p>因为要对多页面应用进行打包，接下来我们要对webpack打包进行多入口处理。多入口处理就是entry接收一个入口的数组。这个数组我们可以根据我们的页面位置和文件名进行手写，但是页面一旦达到一定的量级我们手写的话就会很麻烦，我们可以自动的识别开发的多页面，从而自动生成多入口数组。自动识别文件需要使用到<strong>glob</strong>这个库：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">npm</span> <span class="token function">install</span> -D glob
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后再webpack.config.js中使用：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> argv <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'yargs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> merge <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'glob'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mode <span class="token operator">=</span> argv<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">;</span>
<span class="token comment">// 分环境加载配置</span>
<span class="token keyword">const</span> envConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./build/webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 匹配文件  入口文件统一的命名方式就是为了在这里容易匹配，好处理。</span>
<span class="token keyword">const</span> files <span class="token operator">=</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">'./src/web/views/**/*.entry.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 先来输出一下匹配到的files</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;files ---&gt;&quot;</span><span class="token punctuation">,</span> files<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 公共的webpack配置</span>
<span class="token keyword">const</span> bisicConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token punctuation">,</span>
  entry<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>		<span class="token comment">// 入口 要打包的文件</span>
  output<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>		<span class="token comment">// 出口 打包完成之后输出的文件</span>
  module<span class="token operator">:</span> <span class="token string">&quot;&quot;</span>		<span class="token comment">// 需要打包的模块</span>
<span class="token punctuation">}</span>

<span class="token comment">// 合并配置</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>basicConfig<span class="token punctuation">,</span> envConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><img src="/server/09.png" alt="node-app.png" style="zoom:80%;"> <p>可以看到输出出来的files是一个入口文件路径的数组。下面我们就是要用这个数组来处理成entry入口的数组格式，我们先来看一下entry的入口格式：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">...</span>
<span class="token keyword">const</span> bisicConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token punctuation">,</span>
  entry<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;打包后的文件名称&quot;</span><span class="token operator">:</span> <span class="token string">&quot;打包文件的位置&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;books-create&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./src/web/views/books/books-create.entry.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>		<span class="token comment">// 入口 要打包的文件</span>
  output<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>		<span class="token comment">// 出口 打包完成之后输出的文件</span>
  module<span class="token operator">:</span> <span class="token string">&quot;&quot;</span>		<span class="token comment">// 需要打包的模块</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>接下来我们把entry处理成这个格式：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> argv <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'yargs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> merge <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'glob'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mode <span class="token operator">=</span> argv<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">;</span>
<span class="token comment">// 分环境加载配置</span>
<span class="token keyword">const</span> envConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./build/webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 匹配文件  入口文件统一的命名方式就是为了在这里容易匹配，好处理。</span>
<span class="token keyword">const</span> files <span class="token operator">=</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">'./src/web/views/**/*.entry.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// webpack入口对象</span>
<span class="token keyword">const</span> entries <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">path</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用正则匹配 匹配到”xxx-xxx.entry.js“，然后取出&quot;xxx-xxx&quot;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex">/([a-zA-Z]+-[a-zA-Z]+)\.entry\.js/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> entryKey <span class="token operator">=</span> RegExp<span class="token punctuation">.</span>$<span class="token number">1</span><span class="token punctuation">;</span>
    entries<span class="token punctuation">[</span>entryKey<span class="token punctuation">]</span> <span class="token operator">=</span> path<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出一下处理完的entries</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'entries----&gt;'</span><span class="token punctuation">,</span> entries<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 公共的webpack配置</span>
<span class="token keyword">const</span> bisicConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token punctuation">,</span>
  entry<span class="token operator">:</span> entries<span class="token punctuation">,</span>		<span class="token comment">// 入口 要打包的文件</span>
  output<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>		<span class="token comment">// 出口 打包完成之后输出的文件</span>
  module<span class="token operator">:</span> <span class="token string">&quot;&quot;</span>		<span class="token comment">// 需要打包的模块</span>
<span class="token punctuation">}</span>

<span class="token comment">// 合并配置</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>basicConfig<span class="token punctuation">,</span> envConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><img src="/server/10.png" alt="node-app.png" style="zoom:100%;"> <p>我们可以看到输出的结果，是正确的的，到现在我们已经把多入口对象处理完毕。</p> <p>那么接下来我们配置一下<strong>output对象</strong>，这里我们要使用到node的path对象，来统一不同操作系统的路径。先在<strong>books-list.entry.js</strong>中随意编写一段代码：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// /src/web/views/books-list.entry.js</span>

<span class="token keyword">class</span> <span class="token class-name">BooksList</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'books list init'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">new</span> <span class="token class-name">BooksList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>loader和babel的区别：</p> <ul><li>lodaer是一个转换器，比如说把a.less转成a.css</li> <li>plugin丰富了webpack的功能</li></ul></blockquote> <p>然后，我们安装一下<strong>babel-loader</strong>：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> -D babel-laoder
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们现在开始添加output和model：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> argv <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'yargs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> merge <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'glob'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mode <span class="token operator">=</span> argv<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">;</span>
<span class="token comment">// 分环境加载配置</span>
<span class="token keyword">const</span> envConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./build/webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 匹配文件  入口文件统一的命名方式就是为了在这里容易匹配，好处理。</span>
<span class="token keyword">const</span> files <span class="token operator">=</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">'./src/web/views/**/*.entry.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// webpack入口对象</span>
<span class="token keyword">const</span> entries <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">path</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用正则匹配 匹配到”xxx-xxx.entry.js“，然后取出&quot;xxx-xxx&quot;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex">/([a-zA-Z]+-[a-zA-Z]+)\.entry\.js/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> entryKey <span class="token operator">=</span> RegExp<span class="token punctuation">.</span>$<span class="token number">1</span><span class="token punctuation">;</span>
    entries<span class="token punctuation">[</span>entryKey<span class="token punctuation">]</span> <span class="token operator">=</span> path<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出一下处理完的entries</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'entries----&gt;'</span><span class="token punctuation">,</span> entries<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 公共的webpack配置</span>
<span class="token keyword">const</span> bisicConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token punctuation">,</span>
  entry<span class="token operator">:</span> entries<span class="token punctuation">,</span>		<span class="token comment">// 入口 要打包的文件</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./dist/assets'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'scripts/[name].bundle.js'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>		<span class="token comment">// 出口 打包完成之后输出的文件</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'babel-loader'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>		<span class="token comment">// 需要打包的模块</span>
<span class="token punctuation">}</span>

<span class="token comment">// 合并配置</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>basicConfig<span class="token punctuation">,</span> envConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>这样配置完之后，执行<code>npm run client:dev</code>就可以打包成功。这时你就会发现dist目录里生成了一个scripts目录，目录里生成了两个打包好的文件：<code>books-create-bundle.js</code>、<code>books-list-bundle.js</code>。可以看一下<strong>books-list-bundle.js</strong>里面的内容，你会发现打包出了很多没有见过的代码，这写代码包含了Webpack运行时，然后把我们写的ES6的类，打包成了ES5的原型链写法。</p> <p>通过这种webpack打包的方式我们可以在入口文件中引入JS文件和CSS文件，然后打包完成之后再塞到Node后端的swig模板中去。这是我们使用webpack打包静态前端代码的根本目的。</p> <p><strong>看一下swig模板和组件的使用</strong></p> <p>接下来我们新建一个<strong>src/web/views/layouts/layout.html</strong>：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- src/web/views/layouts/layout.html --&gt;</span>
<span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>{% block title %}{% endblock %}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  {% block head %}{% endblock %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  {% block content %}{% endblock %}
  {% block script %}{% endblock %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>这些<code>{% block xxx %}</code>就是一些占位符，其他的页面都继承自这一页面，然后把不同的内容渲染到占位符中。我们分别说一下layout.html中的占位符：</p> <ul><li><code>{% block title %}{% endblock %}</code> title的占位符</li> <li><code>{% block head %}{% endblock %}</code>head的占位符</li> <li><code>{% block content %}{% endblock %}</code>页面内容的站位符</li> <li><code>{% block Script %}{% endblock %}</code>JS脚本的占位符</li></ul> <p>创建一个前端的组件，在<strong>src/web/components</strong>新建一个nav目录，在里面创建nav.html、nav.css、nav.js：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- src/web/components/nav/nav.html --&gt;</span>
<span class="token comment">&lt;!-- 只需要写内容   不需要写html的完整结构 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>首页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/books/list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>图书列表页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/books/create<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>图书创建页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token comment">/* src/web/components/nav/nav.css */</span>

<span class="token selector">ul</span> <span class="token punctuation">{</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> aqua<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* src/web/components/nav/nav.js */</span>

<span class="token keyword">function</span> <span class="token function">nav</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nav init'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> nav<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>写好了layout页面和nav组件，我们来修改一下<strong>src/web/views/book/book-list.html</strong>，book-list.html页面继承自layout页面，然后把nav组件塞进去：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code>{% extends '../../layouts/layout.html' %}

{% block title %}图书列表页{% endblock %}

{% block head %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
  <span class="token selector">body</span> <span class="token punctuation">{</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> yellow<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
{% endblock %}

{% block content %}
  {% include '../../../components/nav/nav.html' %}
  {% for item in data %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>{{ item.name }} - {{ item.price }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  {% endfor %}
{% endblock %}

{% block script %}
  
{% endblock %}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>list页面继承自layout页面，然后就可以往layout页面里的占位符中渲染dom了，还使用include模板语法引入了一个组件。使用for …… in语法渲染了列表。</p> <p>更改完了list页面之后我们还需要更改一些后端的路由，因为我们的页面的位置在工程化改造过程中发生了变化。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> Controller <span class="token keyword">from</span> <span class="token string">'./Controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> BooksModel <span class="token keyword">from</span> <span class="token string">'../models/BooksModel'</span>

<span class="token keyword">class</span> <span class="token class-name">BooksController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">actionBooksListPage</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'books/list'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> booksModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BooksModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> booksModel<span class="token punctuation">.</span><span class="token function">getBookList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 更改为'books/pages/list'</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'books/pages/list'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> data<span class="token operator">:</span> result<span class="token punctuation">.</span>data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 新建一个actionBooksCreatePage函数，用啦渲染create页面</span>
  <span class="token keyword">async</span> <span class="token function">actionBooksCreatePage</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'books/pages/create'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> BooksController<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>改完之后我们来看一下浏览器的渲染效果，在地址栏输入<code>localhost:8000/books/list</code>：</p> <img src="/server/11.png" alt="node-app.png" style="zoom:100%;"> <p>相同的我们也可以改一下create页面。现在我们模板已经处理的差不多了，接下来就是使用webpack进行打包了，我们需要把JS和CSS文件都打包到HTML中。需要使用<code>html-webpack-plugin</code>。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">npm</span> <span class="token function">install</span> -D html-webpack-plugin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>安装完成之后，在webpack.config.js中引入使用：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> argv <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'yargs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> merge <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 页面模板处理，webpack会把css和js注入到HTML中</span>
<span class="token keyword">const</span> HTMLWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'glob'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mode <span class="token operator">=</span> argv<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">;</span>
<span class="token comment">// 分环境加载配置</span>
<span class="token keyword">const</span> envConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./build/webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 匹配文件  入口文件统一的命名方式就是为了在这里容易匹配，好处理。</span>
<span class="token keyword">const</span> files <span class="token operator">=</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">'./src/web/views/**/*.entry.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// webpack入口对象</span>
<span class="token keyword">const</span> entries <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">path</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用正则匹配 匹配到”xxx-xxx.entry.js“，然后取出&quot;xxx-xxx&quot;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex">/([a-zA-Z]+-[a-zA-Z]+)\.entry\.js/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> entryKey <span class="token operator">=</span> RegExp<span class="token punctuation">.</span>$<span class="token number">1</span><span class="token punctuation">;</span>
    entries<span class="token punctuation">[</span>entryKey<span class="token punctuation">]</span> <span class="token operator">=</span> path<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出一下处理完的entries</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'entries----&gt;'</span><span class="token punctuation">,</span> entries<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 公共的webpack配置</span>
<span class="token keyword">const</span> bisicConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token punctuation">,</span>
  entry<span class="token operator">:</span> entries<span class="token punctuation">,</span>		<span class="token comment">// 入口 要打包的文件</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./dist/assets'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'scripts/[name].bundle.js'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>		<span class="token comment">// 出口 打包完成之后输出的文件</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'babel-loader'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>		<span class="token comment">// 需要打包的模块</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token keyword">new</span> <span class="token class-name">HTMLWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 合并配置</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>basicConfig<span class="token punctuation">,</span> envConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>执行<strong>npm run client:dev</strong>，我们看一下结果：</p> <img src="/server/12.png" alt="node-app.png" style="zoom:100%;"> <p>我们会发现，我们是个多页面应用，但是webpack就打包出一个index.html，这显然是不合适的，这里的html打包和上文中的JS打包相同的需要根据每个入口打包，一个入口文件对应一个html，并且每个html中需要引入各自的JS和CSS而不是全部引入，这样的话我们就要对webpack.config.js进行配置：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> argv <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'yargs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> merge <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 页面模板处理，webpack会把css和js注入到HTML中</span>
<span class="token keyword">const</span> HTMLWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'glob'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mode <span class="token operator">=</span> argv<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">;</span>
<span class="token comment">// 分环境加载配置</span>
<span class="token keyword">const</span> envConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./build/webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 匹配文件  入口文件统一的命名方式就是为了在这里容易匹配，好处理。</span>
<span class="token keyword">const</span> files <span class="token operator">=</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">'./src/web/views/**/*.entry.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// webpack入口对象</span>
<span class="token keyword">const</span> entries <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 多页面资源注入处理</span>
<span class="token keyword">const</span> htmlPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">path</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用正则匹配 匹配到”xxx-xxx.entry.js“，然后取出&quot;xxx-xxx&quot;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex">/([a-zA-Z]+-[a-zA-Z]+)\.entry\.js/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> entryKey <span class="token operator">=</span> RegExp<span class="token punctuation">.</span>$<span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> pageName<span class="token punctuation">,</span> template <span class="token punctuation">]</span> <span class="token operator">=</span> entryKey<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    entries<span class="token punctuation">[</span>entryKey<span class="token punctuation">]</span> <span class="token operator">=</span> path<span class="token punctuation">;</span>
    <span class="token comment">// new HTMLWebpackPlugin要做两个配置，filename是打包之后文件输出到哪里，template是打包的页面在哪儿</span>
    htmlPlugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HTMLWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 这里的路径是以output下的path路径为基准的。</span>
      filename<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../views/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token comment">// 模板文件的路径是以当前webpack文件的位置为基准（正常找就可以）</span>
      template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./src/web/views/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.html</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 公共的webpack配置</span>
<span class="token keyword">const</span> bisicConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token punctuation">,</span>
  entry<span class="token operator">:</span> entries<span class="token punctuation">,</span>		<span class="token comment">// 入口 要打包的文件</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./dist/assets'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'scripts/[name].bundle.js'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>		<span class="token comment">// 出口 打包完成之后输出的文件</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'babel-loader'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>		<span class="token comment">// 需要打包的模块</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token operator">...</span>htmlPlugins <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 合并配置</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>basicConfig<span class="token punctuation">,</span> envConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>现在打包，就会发现打包了多页面。但是现在还存在两个问题：</p> <ul><li>每个html文件中引入了全部的JS文件</li> <li>JS文件并没有被引入到<code>{% block script %}...{% endblock %}</code>里面</li></ul> <p>现在我们要做的就是解决这两个问题。首先处理第一个问题，我们让每个HTML只引入该引入的JS文件并做一个优化把webpack入口的JS文件的运行时代码抽离出来，更改webpack配置：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> argv <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'yargs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> merge <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 页面模板处理，webpack会把css和js注入到HTML中</span>
<span class="token keyword">const</span> HTMLWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'glob'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mode <span class="token operator">=</span> argv<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">;</span>
<span class="token comment">// 分环境加载配置</span>
<span class="token keyword">const</span> envConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./build/webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 匹配文件  入口文件统一的命名方式就是为了在这里容易匹配，好处理。</span>
<span class="token keyword">const</span> files <span class="token operator">=</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">'./src/web/views/**/*.entry.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// webpack入口对象</span>
<span class="token keyword">const</span> entries <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 多页面资源注入处理</span>
<span class="token keyword">const</span> htmlPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">path</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用正则匹配 匹配到”xxx-xxx.entry.js“，然后取出&quot;xxx-xxx&quot;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex">/([a-zA-Z]+-[a-zA-Z]+)\.entry\.js/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> entryKey <span class="token operator">=</span> RegExp<span class="token punctuation">.</span>$<span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> pageName<span class="token punctuation">,</span> template <span class="token punctuation">]</span> <span class="token operator">=</span> entryKey<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    entries<span class="token punctuation">[</span>entryKey<span class="token punctuation">]</span> <span class="token operator">=</span> path<span class="token punctuation">;</span>
    <span class="token comment">// new HTMLWebpackPlugin要做两个配置，filename是打包之后文件输出到哪里，template是打包的页面在哪儿</span>
    htmlPlugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HTMLWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 这里的路径是以output下的path路径为基准的。</span>
      filename<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../views/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token comment">// 模板文件的路径是以当前webpack文件的位置为基准（正常找就可以）</span>
      template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./src/web/views/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token comment">// 解决JS文件全部引入的问题只需要设置chunks为当前入口的entryKey</span>
      chunks<span class="token operator">:</span> <span class="token punctuation">[</span>entryKey<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 公共的webpack配置</span>
<span class="token keyword">const</span> bisicConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token punctuation">,</span>
  entry<span class="token operator">:</span> entries<span class="token punctuation">,</span>		<span class="token comment">// 入口 要打包的文件</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./dist/assets'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'scripts/[name].bundle.js'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>		<span class="token comment">// 出口 打包完成之后输出的文件</span>
  optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
    runtimeChunk<span class="token operator">:</span> <span class="token string">&quot;single&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'babel-loader'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>		<span class="token comment">// 需要打包的模块</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token operator">...</span>htmlPlugins <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 合并配置</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>basicConfig<span class="token punctuation">,</span> envConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>优化完的打包结果如图：</p> <img src="/server/13.png" alt="node-app.png" style="zoom:100%;"> <p>关于第二个问题的解决思路是：</p> <ul><li><p>在要插入JS的地方事先做好标记。</p></li> <li><p>在webpack的打包过程中做拦截，把打包好的JS插入到做标记的地方。类似于Vue的<code>&lt;router-view&gt;</code>。</p></li></ul> <p>到这里我们的Webpack深度细化BFF就完成了一半了。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/L-SUI/note/edit/master/docs/note/server/webpack_bff.md" target="_blank" rel="noopener noreferrer">在 Github 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">8/4/2022, 5:55:00 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/server/vue_ssr.html" class="prev">
        深度实现Vue SSR原理
      </a></span> <span class="next"><a href="/note/server/webpack_bff2.html">
        Webpack从0-1深度细化BFF（二）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.2cd41511.js" defer></script><script src="/assets/js/2.2b5dec35.js" defer></script><script src="/assets/js/92.f297ed2d.js" defer></script>
  </body>
</html>
